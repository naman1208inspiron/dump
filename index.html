<!DOCTYPE html>
<html lang="en" :class="{ 'dark': darkMode }" x-data="app()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pipto - Your DumpYard</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enables manual toggling
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a', // Slate 900
                        darkcard: '#1e293b', // Slate 800
                    }
                }
            }
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        
        /* Smooth transition for theme switch */
        body, div, p, h1, h2, h3, input, textarea, button {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        /* Animation for context menu */
        .animate-scale-in {
            animation: scale-in 0.15s ease-out;
        }
        @keyframes scale-in {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* CSS for the tab scroller to respect the fixed button width (56px) */
        .tab-scroller-fixed {
             /* Adjusted padding to reliably ensure the last tab is fully visible */
            padding-right: 68px !important; 
        }
        
        /* Provider Icons CSS - using filter for dark mode compatibility on white icons */
        .icon-spotify { color: #1DB954; }
        .icon-apple { color: #FC3C44; }
        .icon-youtube { color: #FF0000; }
        .icon-link { color: #2563EB; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-darkbg dark:text-gray-100 h-screen flex flex-col font-sans transition-colors duration-200" x-cloak>

    <header class="bg-white dark:bg-darkcard dark:border-gray-700 p-4 shadow-sm flex justify-between items-center z-20 border-b border-gray-100 transition-colors">
        <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold tracking-tight text-blue-600 dark:text-blue-400">Pipto</h1>
            <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-300 px-2 py-0.5 rounded-full" x-text="'v' + version"></span>
        </div>
        
        <div class="flex items-center gap-3">
            <button @click="openSecureNotesSettings()" class="text-gray-400 hover:text-yellow-600 dark:hover:text-yellow-400 transition-transform active:scale-95">
                <i data-lucide="lock" class="w-5 h-5" :class="activeTab === 'secure' ? 'text-yellow-600 dark:text-yellow-400' : ''"></i>
            </button>
            
            <button @click="openSettingsModal()" class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-transform active:scale-95">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>

            <button @click="toggleTheme()" class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-transform active:scale-95">
                <i x-show="darkMode" data-lucide="sun" class="w-5 h-5"></i>
                <i x-show="!darkMode" data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div class="bg-white dark:bg-darkcard shadow-sm pt-2 pb-0 z-10 transition-colors" x-show="activeTab !== 'secure'">
        <div class="relative flex items-center h-[50px]">
            
            <div class="flex overflow-x-auto no-scrollbar gap-4 pb-0 pl-4 tab-scroller-fixed h-full flex-1" x-ref="tabScroller">
                <div class="flex items-end space-x-4">
                    <template x-for="tab in tabs" :key="tab">
                        <template x-if="tab !== 'secure'">
                            <button 
                                :x-ref="'tab-' + tab" 
                                @click="activeTab = tab; scrollTabIntoView(tab, 'smooth', 'center')"
                                @touchstart.passive="longPressStart($event, tab)"
                                @touchend.passive="longPressEnd($event, tab)"
                                @contextmenu.prevent="openTabContextMenu(tab, $event)"
                                class="pb-3 border-b-2 text-sm font-medium transition-all whitespace-nowrap px-1 select-none"
                                :class="activeTab === tab ? 'border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400' : 'border-transparent text-gray-400 dark:text-gray-500'"
                                x-text="toTitleCase(tab)"
                                x-transition:leave.duration.300>
                            </button>
                        </template>
                    </template>
                </div>
            </div>
            
            <div class="absolute right-0 top-0 bottom-0 bg-white dark:bg-darkcard pl-4 pr-4 border-l border-gray-100 dark:border-gray-700 flex items-center z-20">
                <button @click="openNewTabModal()" class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-4 pb-28" 
        @touchstart.passive="touchStart($event)"
        @touchend.passive="touchEnd($event)">
        
        <div x-show="activeTab === 'secure'" class="text-center bg-gray-100 dark:bg-gray-800 p-4 rounded-xl mb-4 border border-gray-200 dark:border-gray-700">
            <p class="text-gray-700 dark:text-gray-300 font-bold flex justify-center items-center gap-2">
                 <i data-lucide="lock" class="w-5 h-5 text-yellow-500"></i> Secure Notes Active
            </p>
        </div>

        <div x-show="sortedItems.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-300 dark:text-gray-600">
            <i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-50"></i>
            <p>No items in <span class="font-bold text-gray-400 dark:text-gray-500" x-text="activeTab === 'secure' ? 'Secure Notes' : toTitleCase(activeTab)"></span></p>
        </div>

        <div class="grid gap-4">
            <template x-for="item in sortedItems" :key="item.id">
                <div 
                    class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 relative group transition-all hover:shadow-md"
                    :class="{ 'opacity-50 dark:opacity-40': item.isDone }"
                    x-transition:leave.opacity.duration.300> 
                    
                    <button @click.stop="toggleFavorite(item.id)" 
                        x-show="!isTodoTab(activeTab)"
                        class="absolute top-3 right-3 p-2 rounded-full transition-colors z-10"
                        :class="item.isFavorite ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-300 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'">
                        <i data-lucide="heart" class="w-5 h-5" :fill="item.isFavorite ? 'currentColor' : 'none'"></i>
                    </button>

                    <template x-if="isTodoTab(activeTab)">
                        <div class="flex items-start gap-4" @click="openEditItemModal(item)">
                            <div class="mt-1">
                                <input type="checkbox" :checked="item.isDone" 
                                    class="form-checkbox h-6 w-6 text-blue-600 bg-gray-200 dark:bg-gray-700 border-gray-300 rounded focus:ring-blue-500 cursor-pointer transition-colors" 
                                    @click.stop="toggleDone(item.id)">
                            </div>
                            <div class="flex-1 min-w-0 cursor-pointer">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg leading-snug" 
                                    x-text="item.title" 
                                    :class="{ 'line-through text-gray-400 dark:text-gray-500': item.isDone }"></h3>
                                <p x-show="item.note" class="mt-1 text-sm text-gray-500 dark:text-gray-400 whitespace-pre-line" x-text="item.note"></p>
                                <template x-if="item.link">
                                    <a :href="item.link" target="_blank" @click.stop class="inline-flex items-center text-xs font-bold text-blue-600 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 mt-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                        <div x-html="getLinkIcon(item.link)" class="w-4 h-4 mr-1.5 flex items-center justify-center"></div>
                                        <span>Visit Link</span>
                                    </a>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="!isTodoTab(activeTab)">
                        <div @click="openEditItemModal(item)" class="cursor-pointer">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg pr-10 leading-tight" x-text="item.title" :class="{ 'line-through': item.isDone }"></h3>
                            
                            <div class="mt-3 flex items-center gap-2">
                                <template x-if="item.link">
                                    <a :href="item.link" target="_blank" @click.stop class="inline-flex items-center text-xs font-bold text-blue-600 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                        <div x-html="getLinkIcon(item.link)" class="w-4 h-4 mr-1.5 flex items-center justify-center"></div>
                                        <span x-text="activeTab === 'music' ? 'Open Song' : 'Visit Link'"></span>
                                    </a>
                                </template>
                            </div>

                            <div x-show="item.note" class="mt-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-lg whitespace-pre-line border border-gray-100 dark:border-gray-700" x-text="item.note" :class="{ 'line-through': item.isDone }"></div>
                        </div>
                    </template>

                    <div class="mt-3 pt-3 border-t border-gray-50 dark:border-gray-700 flex justify-between items-center">
                         <span class="text-[10px] text-gray-400 dark:text-gray-600" x-text="new Date(item.id).toLocaleDateString()"></span>
                         
                         <div class="flex items-center gap-3">
                            <button @click.stop="toggleDone(item.id)" class="text-xs font-bold transition-colors py-1 px-2 rounded-full"
                                x-show="!isTodoTab(activeTab)"
                                :class="item.isDone ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-300 hover:text-blue-600'">
                                <i data-lucide="check-circle" class="w-3 h-3 inline-block mr-1"></i>
                                <span x-text="item.isDone ? 'UNDONE' : 'MARK DONE'"></span>
                            </button>

                            <button @click.stop="confirmDelete(item.id)" class="text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                         </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <button @click="openAddItemModal()" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-40 ring-2 ring-white dark:ring-gray-800">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <div x-show="modals.tabContext" @click.outside="modals.tabContext = false" 
        class="fixed z-50 rounded-xl shadow-2xl bg-white dark:bg-darkcard border border-gray-200 dark:border-gray-700 p-2 animate-scale-in"
        :style="`top: ${contextMenuY}px; left: ${contextMenuX}px;`">
        
        <div class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 px-2" x-text="toTitleCase(currentContextTab)"></div>
        
        <button @click="openEditTabModal(); modals.tabContext = false;" 
            class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
            <i data-lucide="pencil" class="w-4 h-4 text-blue-500"></i> Rename Tab
        </button>

        <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
        <div class="flex">
            <button @click="moveTab('left'); modals.tabContext = false;" 
                class="flex items-center justify-center flex-1 gap-2 p-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-l-lg disabled:opacity-50 transition-colors"
                :disabled="tabs.indexOf(currentContextTab) === 0">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center justify-center p-2 text-sm font-medium text-gray-700 dark:text-gray-200">
                 Reorder
            </div>
            <button @click="moveTab('right'); modals.tabContext = false;" 
                class="flex items-center justify-center flex-1 gap-2 p-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-r-lg disabled:opacity-50 transition-colors"
                :disabled="tabs.indexOf(currentContextTab) === tabs.length - 1 || tabs[tabs.indexOf(currentContextTab) + 1] === 'secure'">
                <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>

        <button @click="confirmTabDelete(); modals.tabContext = false;" 
            class="flex items-center gap-2 w-full px-3 py-2 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Tab
        </button>
    </div>

    <div x-show="modals.item" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white" x-text="editingItem ? 'Edit Item' : 'Add New'"></h2>
                <button @click="modals.item = false" class="text-gray-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Title / Name</label>
                    <input type="text" x-model="form.title" class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" :placeholder="getTitlePlaceholder()">
                </div>

                <div x-show="activeTab !== 'secure' && !isTodoTab(activeTab)">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Link</label>
                    <div class="flex gap-2">
                        <input type="text" x-model="form.link" class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" 
                            :placeholder="getLinkPlaceholder()">
                        <button x-show="activeTab === 'music'" @click="form.link = autoGenerateMusicLink(form.title)" class="bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 rounded-xl text-xs font-bold border border-red-100 dark:border-red-900">Auto</button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1" x-text="getNoteLabel()"></label>
                    <textarea x-model="form.note" class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none h-24 resize-none" :placeholder="getNotePlaceholder()"></textarea>
                </div>
            </div>

            <button @click="saveItem()" class="w-full mt-6 py-3.5 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform hover:bg-blue-700">
                Save Item
            </button>
        </div>
    </div>

    <div x-show="modals.tab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-xl dark:border dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 dark:text-white">Create New Tab</h2>
            <input type="text" x-model="newTabName" class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border dark:border-gray-600 rounded-xl mb-4" placeholder="e.g. Books, Shopping, Ideas">
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Tab Type</label>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" x-model="newTabType" value="normal" name="tab-type" class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                        <span class="text-sm">Standard (Notes & Links)</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" x-model="newTabType" value="todo" name="tab-type" class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                        <span class="text-sm">To-Do List (Checkboxes)</span>
                    </label>
                </div>
            </div>

            <p class="text-xs text-gray-400 mb-4">This will create a new category.</p>
            <div class="flex gap-3">
                <button @click="modals.tab = false" class="flex-1 py-3 text-gray-500 dark:text-gray-400 font-bold">Cancel</button>
                <button @click="createNewTab()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Create</button>
            </div>
        </div>
    </div>

    <div x-show="modals.editTab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-xl dark:border dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 dark:text-white" x-text="'Rename ' + toTitleCase(currentContextTab)"></h2>
            <input type="text" x-model="editTabName" class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border dark:border-gray-600 rounded-xl mb-4" placeholder="Enter new tab name">
            <div class="flex gap-3">
                <button @click="modals.editTab = false" class="flex-1 py-3 text-gray-500 dark:text-gray-400 font-bold">Cancel</button>
                <button @click="saveTabRename()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Rename</button>
            </div>
        </div>
    </div>

    <div x-show="modals.delete" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">Delete this item?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button @click="modals.delete = false" class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="performDelete()" class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <div x-show="modals.deleteTab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">Delete the '<span x-text="toTitleCase(currentContextTab)"></span>' tab?</h3>
            <p class="text-sm text-red-500 mb-6 font-bold">WARNING: All items in this tab will be permanently lost.</p>
            <div class="flex gap-3">
                <button @click="modals.deleteTab = false" class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="performTabDelete()" class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <div x-show="modals.settings" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-xl dark:border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">App Settings</h2>
                <button @click="modals.settings = false" class="text-gray-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="mb-6 border-b border-gray-100 dark:border-gray-700 pb-6">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Default Starting Tab</label>
                <div class="relative">
                    <select x-model="defaultTabID" @change="persist()" 
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none appearance-none pr-10">
                        <template x-for="tab in tabs" :key="tab">
                            <option :value="tab" x-text="toTitleCase(tab)"></option>
                        </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400 dark:text-gray-500">
                        <i data-lucide="chevron-down" class="w-5 h-5"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">This tab will open automatically when Pipto loads.</p>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Music Link Preference</label>
                <div class="relative">
                    <select x-model="musicAppPreference" @change="persist()" 
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none appearance-none pr-10">
                        <option value="youtube_music">YouTube Music</option>
                        <option value="spotify">Spotify</option>
                        <option value="apple_music">Apple Music</option>
                        <option value="generic_search">Generic Web Search (Fallback)</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400 dark:text-gray-500">
                        <i data-lucide="chevron-down" class="w-5 h-5"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Auto-generated links in the Music tab will open this app directly.</p>
            </div>

            <div class="mb-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                 <h3 class="font-bold text-gray-800 dark:text-white mb-2 flex items-center gap-2">
                    <i data-lucide="lock" class="w-5 h-5 text-yellow-500"></i> Secure Notes
                </h3>
            </div>

            <button @click="modals.settings = false" class="w-full mt-4 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Close</button>
        </div>
    </div>

    <div x-show="updateAvailable" class="fixed bottom-4 left-4 right-4 bg-gray-900 dark:bg-blue-900 text-white p-4 rounded-xl shadow-2xl z-50 flex justify-between items-center ring-1 ring-white/10" x-transition.slide.up>
        <div>
            <p class="font-bold text-sm">New Update Available!</p>
            <p class="text-xs text-gray-400">Restart to apply changes.</p>
        </div>
        <button @click="reloadApp()" class="bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-500">Update</button>
    </div>

    <script>
        function app() {
            return {
                version: '3.4.1', // UPDATED DISPLAY VERSION
                activeTab: 'food',
                tabs: ['food', 'travel', 'movies', 'music', 'secure'],
                data: {}, 
                
                musicAppPreference: 'youtube_music',
                oldMusicAppPreference: 'youtube_music', 
                
                // NEW: Tab metadata for handling tab types (e.g., 'normal', 'todo')
                tabMetadata: {}, 
                
                // Default tab state
                defaultTabID: localStorage.getItem('bd_default_tab') || 'food', 

                // Theme State
                darkMode: false,

                // Swipe State
                touchstartX: 0,
                touchendX: 0,
                swipeThreshold: 75, 

                // Long Press State
                longPressTimer: null,
                longPressDuration: 500, // ms
                currentContextTab: null,
                contextMenuX: 0,
                contextMenuY: 0,

                // Modals State
                modals: { item: false, tab: false, editTab: false, delete: false, deleteTab: false, tabContext: false, settings: false },
                updateAvailable: false,
                
                form: { id: null, title: '', link: '', note: '', isFavorite: false, isDone: false },
                editingItem: false,
                newTabName: '',
                newTabType: 'normal', 
                editTabName: '',
                itemToDelete: null,
                tabToDelete: null,
                
                ANIMATION_DURATION: 300, 

                init() {
                    // 1. Initialize Theme
                    const savedTheme = localStorage.getItem('bd_theme');
                    if (savedTheme) {
                        this.darkMode = savedTheme === 'dark';
                    } else {
                        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                            this.darkMode = true;
                        }
                    }

                    // 2. Load Data and Preferences
                    const sData = localStorage.getItem('bd_data');
                    const sTabs = localStorage.getItem('bd_tabs');
                    const sMusicApp = localStorage.getItem('bd_music_app');
                    const sDefaultTab = localStorage.getItem('bd_default_tab');
                    const sTabMetadata = localStorage.getItem('bd_tab_metadata'); 

                    if (sData) this.data = JSON.parse(sData);
                    if (sTabs) {
                        this.tabs = JSON.parse(sTabs);
                        if (!this.tabs.includes('secure')) {
                            this.tabs.push('secure');
                        }
                    }
                    if (sMusicApp) {
                        this.musicAppPreference = sMusicApp;
                        this.oldMusicAppPreference = sMusicApp; 
                    }
                    
                    // NEW: Initialize or load tab metadata
                    if (sTabMetadata) {
                        this.tabMetadata = JSON.parse(sTabMetadata);
                    }
                    
                    // Ensure all existing tabs (including default ones) have a 'type'
                    this.tabs.forEach(t => {
                        if (!this.tabMetadata[t]) {
                            this.tabMetadata[t] = t === 'secure' ? 'secure' : 'normal'; 
                        }
                    });

                    // Load default tab and set activeTab
                    if (sDefaultTab && this.tabs.includes(sDefaultTab)) {
                        this.defaultTabID = sDefaultTab;
                    }
                    this.activeTab = this.defaultTabID;


                    this.tabs.forEach(t => { 
                        if(!this.data[t]) this.data[t] = [];
                        this.data[t] = this.data[t].map(item => ({
                            ...item,
                            isDone: item.isDone === undefined ? false : item.isDone
                        }));
                    });

                    this.$watch('activeTab', (newTab) => { 
                        this.$nextTick(() => {
                            lucide.createIcons();
                        });
                    });
                    this.$watch('darkMode', () => { this.$nextTick(() => lucide.createIcons()); });
                    
                    // Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('sw.js').then(reg => {
                            reg.addEventListener('waiting', () => {
                                this.updateAvailable = true;
                                this.waitingWorker = reg.waiting;
                            });
                        });
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            window.location.reload();
                        });
                    }
                    
                    this.$nextTick(() => lucide.createIcons());
                },

                scrollTabIntoView(tab, behavior = 'smooth', block = 'center') {
                    const tabElement = this.$refs[`tab-${tab}`];
                    if (tabElement) {
                        tabElement.scrollIntoView({
                            behavior: behavior,
                            inline: block
                        });
                    }
                },
                
                // --- PERSISTENCE AND MIGRATION ---
                updateExistingMusicLinks() {
                    const musicList = this.data['music'] || [];
                    
                    this.data['music'] = musicList.map(item => {
                        const isAutoLink = item.link && (
                            item.link.includes('music.youtube.com/search?q=') ||
                            item.link.includes('spotify.com/search/') ||
                            item.link.includes('music.apple.com/search?term=') ||
                            item.link.includes('google.com/search?q=')
                        );
                        
                        if (item.title && isAutoLink) {
                            item.link = this.autoGenerateMusicLink(item.title);
                        }
                        return item;
                    });
                },

                persist() {
                    if (this.oldMusicAppPreference !== this.musicAppPreference) {
                        this.updateExistingMusicLinks();
                        this.oldMusicAppPreference = this.musicAppPreference; 
                    }

                    localStorage.setItem('bd_data', JSON.stringify(this.data));
                    localStorage.setItem('bd_tabs', JSON.stringify(this.tabs));
                    localStorage.setItem('bd_music_app', this.musicAppPreference);
                    localStorage.setItem('bd_default_tab', this.defaultTabID); 
                    localStorage.setItem('bd_tab_metadata', JSON.stringify(this.tabMetadata));
                    
                    this.$nextTick(() => lucide.createIcons());
                },


                // --- SWIPE HANDLERS ---
                touchStart(e) { this.touchstartX = e.changedTouches[0].screenX; },
                touchEnd(e) { this.touchendX = e.changedTouches[0].screenX; this.handleSwipe(); },

                handleSwipe() {
                    const diff = this.touchstartX - this.touchendX;
                    
                    // 1. Secure Tab Exit Logic: Swipe Right (diff < 0)
                    if (this.activeTab === 'secure') {
                        if (diff < -this.swipeThreshold) { 
                            // Exit to the default tab, prioritizing non-secure tabs
                            const targetTab = (this.defaultTabID && this.defaultTabID !== 'secure') ? this.defaultTabID : 'food';
                            this.activeTab = targetTab;
                            this.scrollTabIntoView(targetTab, 'smooth', 'center');
                        }
                        return;
                    }
                    
                    // 2. Regular Tab Swipe Logic
                    if (Math.abs(diff) > this.swipeThreshold) {
                        const visibleTabs = this.tabs.filter(t => t !== 'secure');
                        const tabsLength = visibleTabs.length;
                        const currentIndex = visibleTabs.indexOf(this.activeTab);

                        let nextIndex;
                        if (diff > 0) { // Swipe Left: Go to next tab (index + 1)
                            nextIndex = (currentIndex + 1) % tabsLength;
                        } else { // Swipe Right: Go to previous tab (index - 1)
                            nextIndex = (currentIndex - 1 + tabsLength) % tabsLength;
                        }
                        this.activeTab = visibleTabs[nextIndex];
                        this.scrollTabIntoView(this.activeTab, 'smooth', 'center');
                    }
                },
                
                // --- LONG PRESS & CONTEXT MENU ---
                longPressStart(e, tab) {
                    if (tab === 'secure') return;
                    this.longPressTimer = setTimeout(() => {
                        this.openTabContextMenu(tab, e);
                    }, this.longPressDuration);
                },

                longPressEnd(e, tab) {
                    clearTimeout(this.longPressTimer);
                    this.longPressTimer = null;
                },

                openTabContextMenu(tab, event) {
                    if (tab === 'secure') return;
                    this.currentContextTab = tab;
                    // Calculate position based on the event or element position
                    const targetRect = event.currentTarget.getBoundingClientRect();
                    
                    let x = targetRect.left;
                    let y = targetRect.bottom + 10;
                    
                    // Prevent menu from going off the right edge (max-w-xs is ~320px)
                    const viewportWidth = window.innerWidth;
                    const menuWidthEstimate = 200; // conservative estimate
                    if (x + menuWidthEstimate > viewportWidth) {
                         x = viewportWidth - menuWidthEstimate - 10; // 10px padding
                    }
                    
                    // Adjust position for right-click event on desktop
                    if (event.clientX && event.clientY) {
                        x = event.clientX;
                        y = event.clientY;
                    }
                    
                    this.contextMenuX = x;
                    this.contextMenuY = y;
                    this.modals.tabContext = true;
                },


                // --- THEME & SETTINGS ---
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('bd_theme', this.darkMode ? 'dark' : 'light');
                },

                openSettingsModal() {
                    this.modals.settings = true;
                },

                openSecureNotesSettings() {
                    this.activeTab = (this.activeTab === 'secure') ? 'food' : 'secure';
                },


                // --- DATA GETTERS ---
                get sortedItems() {
                    const list = this.data[this.activeTab] || [];
                    const isTodo = this.isTodoTab(this.activeTab);

                    return list.sort((a, b) => {
                        if (isTodo) {
                            // Todo sorting: isDone (undone first) > creation date (newest first)
                            if (a.isDone !== b.isDone) return a.isDone - b.isDone; 
                            return b.id - a.id; 
                        } 
                        
                        // Normal sorting: isFavorite (fav first) > isDone (undone first) > creation date (newest first)
                        if (a.isFavorite !== b.isFavorite) return b.isFavorite - a.isFavorite;
                        if (a.isDone !== b.isDone) return a.isDone - b.isDone; 
                        return b.id - a.id;
                    });
                },


                // --- ITEM ACTIONS (FIXED) ---
                openAddItemModal() {
                    this.editingItem = false;
                    this.form = { id: Date.now(), title: '', link: '', note: '', isFavorite: false, isDone: false };
                    this.modals.item = true;
                },

                openEditItemModal(item) {
                    this.editingItem = true;
                    this.form = { ...item };
                    this.modals.item = true;
                },

                saveItem() {
                    if (!this.form.title) return;
                    let list = this.data[this.activeTab];
                    
                    // Clear link if in secure mode OR a To-Do List tab
                    if (this.activeTab === 'secure' || this.isTodoTab(this.activeTab)) {
                        this.form.link = ''; 
                    }

                    if (this.editingItem) {
                        const index = list.findIndex(i => i.id === this.form.id);
                        if (index !== -1) {
                            // Logic to update music link if title is changed and it was an auto-link
                            const oldItem = list[index];
                            if (this.activeTab === 'music' && oldItem.title !== this.form.title && (oldItem.link === this.autoGenerateMusicLink(oldItem.title) || !this.form.link)) {
                                this.form.link = this.autoGenerateMusicLink(this.form.title);
                            }
                            list[index] = { ...this.form };
                        }
                    } else {
                        // Auto-generate link on creation if required (only for music tab, which is 'normal')
                        if (!this.form.link && this.activeTab === 'music') {
                            this.form.link = this.autoGenerateMusicLink(this.form.title);
                        }
                        list.unshift(this.form);
                    }
                    this.persist();
                    this.modals.item = false;
                    this.$nextTick(() => lucide.createIcons());
                },

                confirmDelete(id) {
                    this.itemToDelete = id;
                    this.modals.delete = true;
                },

                performDelete() {
                    if (this.itemToDelete) {
                        this.modals.delete = false;
                        setTimeout(() => {
                            if (this.data[this.activeTab].some(i => i.id === this.itemToDelete)) {
                                this.data[this.activeTab] = this.data[this.activeTab].filter(i => i.id !== this.itemToDelete);
                                this.persist();
                            }
                            this.itemToDelete = null;
                        }, this.ANIMATION_DURATION); 
                    }
                },

                toggleFavorite(id) {
                    const item = this.data[this.activeTab].find(i => i.id === id);
                    if (item) {
                        item.isFavorite = !item.isFavorite;
                        this.persist(); 
                    }
                },

                toggleDone(id) {
                    const item = this.data[this.activeTab].find(i => i.id === id);
                    if (item) {
                        item.isDone = !item.isDone;
                        this.persist(); 
                    }
                },


                // --- TAB ACTIONS (MODIFIED) ---
                openNewTabModal() {
                    this.newTabName = '';
                    this.newTabType = 'normal'; 
                    this.modals.tab = true;
                },

                createNewTab() {
                    const newName = this.newTabName.trim().toLowerCase().replace(/\s+/g, '-');
                    if (newName && !this.tabs.includes(newName)) {
                        // Find the index before 'secure' to insert the new tab
                        const secureIndex = this.tabs.indexOf('secure');
                        this.tabs.splice(secureIndex, 0, newName);
                        this.data[newName] = [];
                        this.tabMetadata[newName] = this.newTabType; 
                        this.activeTab = newName; // This line automatically opens the new tab
                        this.persist();
                        this.modals.tab = false;
                        
                        // FIX: Scroll to the end of the tab scroller to ensure the new tab is fully visible.
                        // Manually scroll to the maximum right position to reliably show the last tab,
                        // overriding the scrollIntoView issue with fixed overlays.
                        this.$nextTick(() => {
                            const scroller = this.$refs.tabScroller;
                            if (scroller) {
                                scroller.scrollTo({
                                    left: scroller.scrollWidth,
                                    behavior: 'smooth'
                                });
                            }
                        });
                    }
                },

                openEditTabModal() {
                    this.editTabName = this.toTitleCase(this.currentContextTab);
                    this.modals.editTab = true;
                },

                saveTabRename() {
                    const oldName = this.currentContextTab;
                    const newName = this.editTabName.trim().toLowerCase().replace(/\s+/g, '-');

                    if (newName && newName !== oldName && !this.tabs.includes(newName)) {
                        const index = this.tabs.indexOf(oldName);
                        if (index !== -1) {
                            // 1. Rename the data key
                            this.data[newName] = this.data[oldName];
                            delete this.data[oldName];

                            // 2. Transfer metadata
                            this.tabMetadata[newName] = this.tabMetadata[oldName];
                            delete this.tabMetadata[oldName];
                            
                            // 3. Rename the tab in the array
                            this.tabs.splice(index, 1, newName);
                            this.activeTab = newName;
                            this.persist();
                            this.modals.editTab = false;
                            this.$nextTick(() => this.scrollTabIntoView(newName, 'smooth', 'center'));
                        }
                    }
                },

                confirmTabDelete() {
                    if (this.currentContextTab === 'secure' || this.tabs.length <= 2) return; 
                    this.tabToDelete = this.currentContextTab;
                    this.modals.deleteTab = true;
                },

                performTabDelete() {
                    if (this.tabToDelete) {
                        this.modals.deleteTab = false;
                        setTimeout(() => {
                            const index = this.tabs.indexOf(this.tabToDelete);
                            if (index > -1) {
                                // 1. Delete data
                                delete this.data[this.tabToDelete];

                                // 2. Delete metadata
                                delete this.tabMetadata[this.tabToDelete];
                                
                                // 3. Delete tab
                                this.tabs.splice(index, 1);

                                // 4. Set new active tab (fall back to 'food')
                                this.activeTab = this.tabs[0]; 

                                this.persist();
                            }
                            this.tabToDelete = null;
                        }, this.ANIMATION_DURATION);
                    }
                },
                
                moveTab(direction) {
                    const tab = this.currentContextTab;
                    const currentIndex = this.tabs.indexOf(tab);
                    const newIndex = direction === 'right' ? currentIndex + 1 : currentIndex - 1;

                    if (newIndex >= 0 && newIndex < this.tabs.length && this.tabs[newIndex] !== 'secure') {
                        // Remove current tab
                        this.tabs.splice(currentIndex, 1);
                        // Insert at new position
                        this.tabs.splice(newIndex, 0, tab);
                        this.persist();
                        this.$nextTick(() => this.scrollTabIntoView(tab, 'smooth', 'center'));
                    }
                },


                // --- HELPERS ---
                isTodoTab(tabName) {
                    return this.tabMetadata[tabName] === 'todo';
                },

                toTitleCase(str) {
                    if (!str) return '';
                    return str.split(' ').map(word => {
                        return word.charAt(0).toUpperCase() + word.slice(1);
                    }).join(' ');
                },
                
                // Returns the deep-link URL (using search link for app handling)
                autoGenerateMusicLink(title) {
                    if (!title) return '';
                    const encodedTitle = encodeURIComponent(title);

                    switch(this.musicAppPreference) {
                        case 'spotify':
                            // Uses a generic Spotify search link which is recognized by the app
                            return `spotify.com/search/${encodedTitle}`;
                        case 'apple_music':
                            return `https://music.apple.com/search?term=${encodedTitle}`;
                        case 'generic_search':
                            return `https://google.com/search?q=${encodedTitle}+song`;
                        case 'youtube_music':
                        default:
                            return `https://music.youtube.com/search?q=${encodedTitle}`;
                    }
                },
                
                // Returns the appropriate SVG/Icon for the link
                getLinkIcon(link) {
                    if (!link) return `<i data-lucide="link" class="w-4 h-4 icon-link"></i>`;

                    // Note: Use a substring check here for robustness against future changes to the URL query string
                    if (link.includes('spotify.com/4')) { 
                        // Simple Spotify Icon SVG (Green)
                        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-spotify w-4 h-4"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.838 17.51a.637.637 0 01-.893.208c-2.348-1.425-5.26-1.742-8.69-.974a.637.637 0 01-.525-.797.637.637 0 01.797-.525c3.742-.85 6.942-.51 9.452 1.056a.637.637 0 01.209.894zm1.967-3.414a.798.798 0 01-1.096.258c-2.887-1.782-7.23-2.28-11.75-.95a.798.798 0 01-.637-.998.798.798 0 01.998-.637c5.076-1.43 9.87.05 13.085 2.016a.798.798 0 01.259 1.096zM12 4.1a8.17 8.17 0 015.71 1.768c3.21 2.008 5.32 4.54 5.32 6.892 0 1.25-2.09 3.19-5.11 5.09-2.91 1.84-6.49 2.1-10.02.666-4.646-1.92-5.917-5.46-5.917-9.43.003-2.14 2.15-4.59 5.32-6.52A8.17 8.17 0 0112 4.1z"/></svg>`;
                    } else if (link.includes('music.apple.com')) {
                        // Simple Apple Music Icon (Red)
                        return `<i data-lucide="apple" class="w-4 h-4 icon-apple" fill="currentColor"></i>`;
                    } else if (link.includes('youtube.com')) {
                        // Simple YouTube Icon (Red)
                        return `<i data-lucide="youtube" class="w-4 h-4 icon-youtube" fill="currentColor"></i>`;
                    } else {
                        // Generic Link Icon
                        return `<i data-lucide="link" class="w-4 h-4 icon-link"></i>`;
                    }
                },
                
                // HINT TEXTS
                getTitlePlaceholder() {
                    if (this.isTodoTab(this.activeTab)) return 'e.g. Buy milk, Call dentist';
                    if (this.activeTab === 'food') return 'e.g. Grandma\'s Pasta';
                    if (this.activeTab === 'travel') return 'e.g. Paris Trip';
                    if (this.activeTab === 'music') return 'e.g. Bohemian Rhapsody';
                    if (this.activeTab === 'movies') return 'e.g. Inception';
                    if (this.activeTab === 'secure') return 'e.g. Bank Login or Wi-Fi Password';
                    return 'e.g. Item Title';
                },

                getLinkPlaceholder() {
                    if (this.activeTab === 'music') return 'https:// or tap "Auto"';
                    return 'https://... (Optional)';
                },

                getNoteLabel() {
                    if (this.isTodoTab(this.activeTab)) return 'Extra Details (Optional)';
                    if (this.activeTab === 'food') return 'Ingredients & Steps';
                    if (this.activeTab === 'travel') return 'Location Details';
                    if (this.activeTab === 'secure') return 'Sensitive Information / Password Notes';
                    return 'Notes / Details';
                },

                getNotePlaceholder() {
                    if (this.isTodoTab(this.activeTab)) return 'Set a deadline, or add a store location.';
                    if (this.activeTab === 'food') return '- 2 Cups Rice\n- Boil water...';
                    if (this.activeTab === 'travel') return 'Best time to visit: October\nGoogle Map Coords...';
                    if (this.activeTab === 'secure') return 'Write your secure notes here.';
                    return 'Add any extra details here...';
                },
                
                reloadApp() {
                    if (this.waitingWorker) this.waitingWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            }
        }
    </script>
</body>
</html>