<!DOCTYPE html>
<html lang="en" :class="{ 'dark': darkMode }" x-data="app()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pipto - Your DumpYard</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        voice: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95'
                        }
                    }
                }
            }
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            -webkit-tap-highlight-color: transparent;
        }

        [x-cloak] {
            display: none !important;
        }

        body,
        div,
        p,
        h1,
        h2,
        h3,
        input,
        textarea,
        button {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .animate-scale-in {
            animation: scale-in 0.15s ease-out;
        }

        @keyframes scale-in {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .tab-scroller-fixed {
            padding-right: 68px !important;
        }

        .icon-spotify {
            color: #1DB954;
        }

        .icon-apple {
            color: #FC3C44;
        }

        .icon-youtube {
            color: #FF0000;
        }

        .icon-link {
            color: #2563EB;
        }

        @keyframes slide-in-from-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in-right {
            animation: slide-in-from-right 0.3s ease-out;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out;
        }

        .home-grid-item {
            aspect-ratio: 1 / 1;
        }

        .home-dashboard-container {
            height: calc(100vh - 64px);
        }

        /* Voice Recording Animation - Minimal */
        .pulse-ring {
            animation: pulse-ring 1.5s ease-in-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.4;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.8;
            }
        }

        .waveform-minimal {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 20px;
        }

        .waveform-bar-minimal {
            width: 2px;
            background: #8b5cf6;
            border-radius: 2px;
            animation: waveform-minimal 1.2s ease-in-out infinite;
        }

        .waveform-bar-minimal:nth-child(1) {
            animation-delay: 0s;
            height: 6px;
        }

        .waveform-bar-minimal:nth-child(2) {
            animation-delay: 0.2s;
            height: 12px;
        }

        .waveform-bar-minimal:nth-child(3) {
            animation-delay: 0.4s;
            height: 18px;
        }

        .waveform-bar-minimal:nth-child(4) {
            animation-delay: 0.6s;
            height: 14px;
        }

        .waveform-bar-minimal:nth-child(5) {
            animation-delay: 0.8s;
            height: 10px;
        }

        @keyframes waveform-minimal {

            0%,
            100% {
                transform: scaleY(1);
            }

            50% {
                transform: scaleY(0.5);
            }
        }

        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        /* Todo specific styles */
        .todo-scaffold {
            border-left: 2px dashed #d1d5db;
            margin-left: 1rem;
            padding-left: 1.5rem;
        }

        .dark .todo-scaffold {
            border-left-color: #4b5563;
        }

        .todo-task-item {
            transition: all 0.2s ease;
        }

        .todo-task-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>

<body
    class="bg-gray-50 text-gray-800 dark:bg-darkbg dark:text-gray-100 h-screen flex flex-col font-sans transition-colors duration-200"
    x-cloak>

    <header
        class="bg-white dark:bg-darkcard dark:border-gray-700 p-4 shadow-sm flex justify-between items-center z-20 border-b border-gray-100 transition-colors">
        <div class="flex items-center gap-2">
            <button @click="goToHome()" class="flex items-center gap-2 cursor-pointer">
                <h1 class="text-xl font-bold tracking-tight text-blue-600 dark:text-blue-400">Pipto - Your DumpYard</h1>
                <i x-show="currentView !== 'home'" data-lucide="home" class="w-4 h-4 text-blue-500"></i>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <button @click="openSettingsModal()"
                class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-transform active:scale-95">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- HOME DASHBOARD -->
    <div x-show="currentView === 'home'" x-transition:enter.duration.300
        class="home-dashboard-container flex flex-col animate-fade-in-up">

        <div class="flex-1 overflow-y-auto p-3">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 w-full max-w-4xl mx-auto">
                <template x-for="tab in tabs" :key="tab">
                    <template x-if="tab !== 'secure-notes' && tab !== 'cards' && tab !== 'voice' && tab !== 'todo'">
                        <button @click="switchToTab(tab)" @touchstart.passive="homeLongPressStart($event, tab)"
                            @touchend.passive="homeLongPressEnd($event, tab)"
                            @contextmenu.prevent="openTabContextMenu(tab, $event)"
                            class="bg-white dark:bg-darkcard p-3 rounded-xl shadow border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-1 transition-all hover:scale-[1.02] hover:shadow-md active:scale-95 group home-grid-item">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center group-hover:bg-blue-100 dark:group-hover:bg-blue-800/30 transition-colors">
                                <i :data-lucide="getTabIcon(tab)" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <span class="font-bold text-gray-800 dark:text-gray-100 text-xl"
                                x-text="toTitleCase(tab)"></span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                <span x-text="getTabCount(tab)"></span> items
                            </span>
                        </button>
                    </template>
                </template>
                
                <!-- Todo Tab Button -->
                <button @click="switchToTab('todo')" 
                    class="bg-gradient-to-br from-purple-50 to-indigo-100 dark:from-purple-900/20 dark:to-indigo-900/20 p-3 rounded-xl shadow border border-purple-100 dark:border-purple-800/30 flex flex-col items-center justify-center gap-1 transition-all hover:scale-[1.02] hover:shadow-md active:scale-95 group home-grid-item">
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-100 to-indigo-200 dark:from-purple-800/30 dark:to-indigo-800/30 flex items-center justify-center group-hover:from-purple-200 group-hover:to-indigo-300 dark:group-hover:from-purple-700/40 dark:group-hover:to-indigo-700/40 transition-colors">
                        <i data-lucide="check-square" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-100 text-xl">To-Do</span>
                    <span class="text-sm text-purple-600 dark:text-purple-400">
                        <span x-text="getTodoUndoneCount()"></span> pending
                    </span>
                </button>
            </div>
        </div>

        <!-- Bottom Tab Bar -->
        <div
            class="flex-shrink-0 p-3 bg-gradient-to-t from-white via-white to-white/95 dark:from-darkbg dark:via-darkbg dark:to-darkbg/95 backdrop-blur-sm border-t border-gray-100 dark:border-gray-700 sticky bottom-0">
            <div class="grid grid-cols-4 gap-3 max-w-4xl mx-auto">
                <button @click="switchToTab('voice')"
                    class="flex flex-col items-center justify-center p-3 rounded-lg bg-gradient-to-br from-voice-50 to-voice-100 dark:from-voice-900/30 dark:to-voice-800/20 hover:from-voice-100 hover:to-voice-200 dark:hover:from-voice-800/40 dark:hover:to-voice-700/30 transition-all active:scale-95 group border border-voice-100 dark:border-voice-800/30 shadow-sm">
                    <i data-lucide="mic"
                        class="w-5 h-5 text-voice-600 dark:text-voice-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm text-gray-800 dark:text-gray-100">Voice</span>
                    <span class="text-xs text-voice-600 dark:text-voice-400 mt-0.5"
                        x-text="getTabCount('voice')"></span>
                </button>

                <button @click="switchToTab('secure-notes')"
                    class="flex flex-col items-center justify-center p-3 rounded-lg bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/30 dark:to-yellow-800/20 hover:from-yellow-100 hover:to-yellow-200 dark:hover:from-yellow-800/40 dark:hover:to-yellow-700/30 transition-all active:scale-95 group border border-yellow-100 dark:border-yellow-800/30 shadow-sm">
                    <i data-lucide="lock"
                        class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm text-gray-800 dark:text-gray-100">Secure</span>
                    <span class="text-xs text-yellow-600 dark:text-yellow-400 mt-0.5"
                        x-text="secureNotes.length"></span>
                </button>

                <button @click="switchToTab('cards')"
                    class="flex flex-col items-center justify-center p-3 rounded-lg bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20 hover:from-blue-100 hover:to-blue-200 dark:hover:from-blue-800/40 dark:hover:to-blue-700/30 transition-all active:scale-95 group border border-blue-100 dark:border-blue-800/30 shadow-sm">
                    <i data-lucide="credit-card"
                        class="w-5 h-5 text-blue-600 dark:text-blue-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm text-gray-800 dark:text-gray-100">Cards</span>
                    <span class="text-xs text-blue-600 dark:text-blue-400 mt-0.5" x-text="cards.length"></span>
                </button>

                <button @click="openNewTabModal()"
                    class="flex flex-col items-center justify-center p-3 rounded-lg bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20 hover:from-green-100 hover:to-green-200 dark:hover:from-green-800/40 dark:hover:to-green-700/30 transition-all active:scale-95 group border border-green-100 dark:border-green-800/30 shadow-sm">
                    <i data-lucide="plus-circle"
                        class="w-5 h-5 text-green-600 dark:text-green-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm text-gray-800 dark:text-gray-100">New Tab</span>
                    <span class="text-xs text-green-600 dark:text-green-400 mt-0.5">+</span>
                </button>
            </div>
        </div>
    </div>

    <!-- TAB VIEW -->
    <div x-show="currentView === 'tab'" x-transition:enter.duration.300>
        <div class="bg-white dark:bg-darkcard shadow-sm pt-2 pb-0 z-10 transition-colors"
            x-show="activeTab !== 'secure-notes' && activeTab !== 'cards' && activeTab !== 'voice' && activeTab !== 'todo'">
            <div class="relative flex items-center h-[50px]">

                <div class="flex overflow-x-auto no-scrollbar gap-4 pb-0 pl-4 tab-scroller-fixed h-full flex-1"
                    x-ref="tabScroller">
                    <div class="flex items-end space-x-4">
                        <template x-for="tab in tabs" :key="tab">
                            <template x-if="tab !== 'secure-notes' && tab !== 'cards' && tab !== 'voice' && tab !== 'todo'">
                                <button :x-ref="'tab-' + tab" :id="getTabElementID(tab)"
                                    @click="if (!longPressActive) { activeTab = tab; scrollTabIntoView(tab, 'smooth', 'center'); }"
                                    @touchstart.passive="longPressStart($event, tab)"
                                    @touchend.passive="longPressEnd($event, tab)"
                                    @contextmenu.prevent="openTabContextMenu(tab, $event)"
                                    class="pb-3 border-b-2 text-sm font-medium transition-all whitespace-nowrap px-1 select-none"
                                    :class="activeTab === tab ? 'border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400' : 'border-transparent text-gray-400 dark:text-gray-500'"
                                    x-text="toTitleCase(tab)" x-transition:leave.duration.300>
                                </button>
                            </template>
                        </template>
                    </div>
                </div>

                <div
                    class="absolute right-0 top-0 bottom-0 bg-white dark:bg-darkcard pl-4 pr-4 border-l border-gray-100 dark:border-gray-700 flex items-center z-20">
                    <button @click="openNewTabModal()"
                        class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto p-4 pb-28" @touchstart.passive="touchStart($event)"
            @touchend.passive="touchEnd($event)">

            <!-- Todo Tab Display -->
            <div x-show="activeTab === 'todo'" class="flex flex-col h-full animate-slide-in-right">
                <div class="flex justify-between items-center py-3 px-1">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">To-Do List</h2>
                    <div class="flex items-center gap-2">
                        <button @click="openTodoVoiceModal()"
                            class="p-2 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 hover:bg-purple-200 dark:hover:bg-purple-800/40 transition-colors">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-blue-500"></i>
                            Today
                            <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                                (<span x-text="getTodayTodoCount()"></span> tasks)
                            </span>
                        </h3>
                        <button @click="openAddTodoModal()"
                            class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add Task
                        </button>
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="item in sortedTodoItems" :key="item.id">
                            <template x-if="isToday(item.date)">
                                <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 todo-task-item"
                                    :class="{ 'opacity-60': item.isDone }">
                                    <div class="flex items-start gap-3">
                                        <button @click="toggleTodoDone(item.id)"
                                            class="mt-1 flex-shrink-0">
                                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                                :class="item.isDone ? 'bg-green-500 border-green-500' : 'border-gray-300 dark:border-gray-600 hover:border-blue-500'">
                                                <i x-show="item.isDone" data-lucide="check" class="w-3 h-3 text-white"></i>
                                            </div>
                                        </button>
                                        
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-medium text-gray-800 dark:text-gray-100"
                                                :class="{ 'line-through text-gray-400 dark:text-gray-500': item.isDone }"
                                                x-text="item.title || 'Untitled Task'"></h3>
                                            <p x-show="item.note" class="mt-1 text-sm text-gray-500 dark:text-gray-400"
                                                x-text="item.note"></p>
                                        </div>
                                        
                                        <div class="flex items-center gap-2">
                                            <button @click.stop="toggleTodoFavorite(item.id)"
                                                class="p-1 rounded-full transition-colors"
                                                :class="item.isFavorite ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-300 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                                <i data-lucide="heart" class="w-4 h-4"
                                                    :fill="item.isFavorite ? 'currentColor' : 'none'"></i>
                                            </button>
                                            <button @click.stop="confirmDeleteItem(item.id, 'todo')"
                                                class="p-1 text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                        
                        <div x-show="getTodayTodoCount() === 0"
                            class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-100 dark:border-gray-700 text-center">
                            <i data-lucide="check-circle" class="w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"></i>
                            <p class="text-gray-500 dark:text-gray-400">No tasks for today. Add some tasks to get started!</p>
                        </div>
                    </div>
                </div>

                <!-- Previous Days - Collapsible -->
                <div x-show="getPreviousDaysTodoCount() > 0">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                            <i data-lucide="archive" class="w-5 h-5 text-gray-500"></i>
                            Previous Days
                            <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                                (<span x-text="getPreviousDaysTodoCount()"></span> tasks)
                            </span>
                        </h3>
                        <button @click="showPreviousDays = !showPreviousDays"
                            class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i :data-lucide="showPreviousDays ? 'chevron-up' : 'chevron-down'" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div x-show="showPreviousDays" class="todo-scaffold space-y-3">
                        <template x-for="item in sortedTodoItems" :key="item.id">
                            <template x-if="!isToday(item.date)">
                                <div class="bg-gray-50 dark:bg-gray-800/30 p-3 rounded-lg border border-gray-100 dark:border-gray-700 todo-task-item"
                                    :class="{ 'opacity-60': item.isDone }">
                                    <div class="flex items-start gap-3">
                                        <div class="mt-1 flex-shrink-0">
                                            <div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center">
                                                <i x-show="item.isDone" data-lucide="check" class="w-3 h-3 text-gray-400"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-xs text-gray-500 dark:text-gray-400"
                                                    x-text="formatTodoDate(item.date)"></span>
                                            </div>
                                            <h3 class="font-medium text-gray-700 dark:text-gray-300"
                                                :class="{ 'line-through text-gray-400': item.isDone }"
                                                x-text="item.title || 'Untitled Task'"></h3>
                                            <p x-show="item.note" class="mt-1 text-xs text-gray-500 dark:text-gray-400"
                                                x-text="item.note"></p>
                                        </div>
                                        
                                        <div class="flex items-center gap-1">
                                            <button @click.stop="moveTodoToToday(item.id)"
                                                class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded"
                                                title="Move to Today">
                                                Today
                                            </button>
                                            <button @click.stop="confirmDeleteItem(item.id, 'todo')"
                                                class="p-1 text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                </div>
                
                <div x-show="getTodoCount() === 0" class="text-center py-12">
                    <div class="w-20 h-20 rounded-full bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check-square" class="w-10 h-10 text-purple-500 dark:text-purple-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-2">No tasks yet</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-sm mx-auto">Start adding tasks to stay organized. Use voice input for quick entry!</p>
                    <div class="flex justify-center gap-3">
                        <button @click="openAddTodoModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add Task
                        </button>
                        <button @click="openTodoVoiceModal()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2">
                            <i data-lucide="mic" class="w-4 h-4"></i> Voice Input
                        </button>
                    </div>
                </div>
            </div>

            <!-- Voice Tab Display -->
            <div x-show="activeTab === 'voice'"
                class="text-center bg-voice-50 dark:bg-voice-900/20 p-4 rounded-xl mb-4 border border-voice-100 dark:border-voice-800/30">
                <p class="text-gray-700 dark:text-gray-300 font-bold flex justify-center items-center gap-2">
                    <i data-lucide="mic" class="w-5 h-5 text-voice-600"></i> Voice Notes
                </p>
            </div>

            <div x-show="activeTab === 'secure-notes'"
                class="text-center bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl mb-4 border border-yellow-100 dark:border-yellow-800/30">
                <p class="text-gray-700 dark:text-gray-300 font-bold flex justify-center items-center gap-2">
                    <i data-lucide="lock" class="w-5 h-5 text-yellow-600"></i> Secure Notes
                </p>
            </div>

            <div x-show="activeTab === 'cards'" class="flex flex-col h-full -mt-4 animate-slide-in-right">
                <div class="grid gap-4 mt-4">
                    <div class="flex justify-between items-center py-3 px-1">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Secure Cards</h2>
                    </div>

                    <template x-for="card in cards" :key="card.id">
                        <div @click="openEditCardModal(card)"
                            class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 cursor-pointer transition-transform hover:scale-[1.01] relative overflow-hidden group">
                            <div class="absolute inset-0 rounded-xl -z-0 transform transition-transform group-hover:scale-105"
                                :style="getCardGradient(card.color)">
                            </div>

                            <div class="relative z-10 text-white">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-lg" x-text="card.title || 'Untitled Card'"></span>
                                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                                </div>

                                <div
                                    class="mt-6 font-mono text-xl sm:text-2xl tracking-widest break-all flex items-center gap-2">
                                    <span x-text="formatCardNumberFull(card.number)"></span>
                                    <button @click.stop="copyToClipboard(card.number, 'Card Number')"
                                        class="p-1 text-gray-200 hover:text-white active:scale-95 transition-transform">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <div class="flex justify-between mt-4 text-sm">
                                    <div x-show="card.holder" class="flex items-center gap-2">
                                        <div>
                                            <span class="text-xs opacity-70 block">Card Holder</span>
                                            <span class="font-medium uppercase" x-text="card.holder"></span>
                                        </div>
                                        <button @click.stop="copyToClipboard(card.holder, 'Card Holder')"
                                            class="p-1 text-gray-200 hover:text-white active:scale-95 transition-transform">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>

                                    <div x-show="card.expiry" class="flex items-center gap-2">
                                        <div>
                                            <span class="text-xs opacity-70 block">Expires</span>
                                            <span class="font-medium" x-text="formatExpiryDisplay(card.expiry)"></span>
                                        </div>
                                        <button @click.stop="copyToClipboard(card.expiry, 'Expiry Date')"
                                            class="p-1 text-gray-200 hover:text-white active:scale-95 transition-transform">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>

                                    <div x-show="card.cvv" class="flex items-center gap-2">
                                        <div>
                                            <span class="text-xs opacity-70 block">CVV</span>
                                            <span class="font-medium" x-text="card.cvv"></span>
                                        </div>
                                        <button @click.stop="copyToClipboard(card.cvv, 'CVV')"
                                            class="p-1 text-gray-200 hover:text-white active:scale-95 transition-transform">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                                <div x-show="card.note" class="mt-4 text-xs">
                                    <div
                                        class="flex items-start justify-between bg-white/10 p-3 rounded-lg border border-white/20">
                                        <p class="opacity-80 whitespace-pre-line break-words mr-2" x-text="card.note">
                                        </p>
                                        <button @click.stop="copyToClipboard(card.note, 'Note')"
                                            class="p-1 flex-shrink-0 text-gray-200 hover:text-white active:scale-95 transition-transform">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex justify-end mt-4">
                                    <button @click.stop="confirmDeleteItem(card.id, 'cards')"
                                        class="text-red-300 hover:text-red-100 p-1 transition-colors">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div x-show="cards.length === 0"
                        class="flex flex-col items-center justify-center text-gray-300 dark:text-gray-600 mt-10">
                        <i data-lucide="credit-card" class="w-16 h-16 mb-4 opacity-50"></i>
                        <p>No cards saved.</p>
                    </div>
                </div>
            </div>

            <!-- Voice Notes Display -->
            <div x-show="activeTab === 'voice'" class="grid gap-4">
                <template x-for="item in sortedItems" :key="item.id">
                    <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 relative group transition-all hover:shadow-md"
                        :class="{ 'opacity-50 dark:opacity-40': item.isDone }" x-transition:leave.opacity.duration.300>

                        <div @click="openEditItemModal(item)" class="cursor-pointer">
                            <div x-show="item.note"
                                class="text-sm text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg whitespace-pre-line border border-gray-100 dark:border-gray-700"
                                x-text="item.note"></div>
                        </div>

                        <div
                            class="mt-3 pt-3 border-t border-gray-50 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-[10px] text-gray-400 dark:text-gray-600"
                                x-text="new Date(item.id).toLocaleDateString()"></span>

                            <div class="flex items-center gap-3">
                                <button @click.stop="toggleFavorite(item.id)"
                                    class="p-1 rounded-full transition-colors active:scale-95"
                                    :class="item.isFavorite ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-300 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="heart" class="w-5 h-5"
                                        :fill="item.isFavorite ? 'currentColor' : 'none'"></i>
                                </button>

                                <button @click.stop="toggleDone(item.id)"
                                    class="text-xs font-bold transition-colors py-1 px-2 rounded-full"
                                    :class="item.isDone ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-300 hover:text-blue-600'">
                                    <i data-lucide="check-circle" class="w-3 h-3 inline-block mr-1"></i>
                                    <span x-text="item.isDone ? 'UNDONE' : 'MARK DONE'"></span>
                                </button>

                                <button @click.stop="confirmDeleteItem(item.id, activeTab)"
                                    class="text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="sortedItems.length === 0 && activeTab === 'voice'"
                    class="flex flex-col items-center justify-center py-16 text-gray-300 dark:text-gray-600">
                    <div
                        class="w-20 h-20 rounded-full bg-voice-50 dark:bg-voice-900/20 flex items-center justify-center mb-4">
                        <i data-lucide="mic" class="w-8 h-8 text-voice-400 dark:text-voice-500"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-400 dark:text-gray-500 mb-2">No voice notes yet</p>
                    <p class="text-sm text-gray-400 dark:text-gray-600 text-center max-w-xs">
                        Tap the microphone button to record your first voice note
                    </p>
                </div>
            </div>

            <!-- Other Tabs Display -->
            <div class="grid gap-4"
                x-show="activeTab !== 'cards' && activeTab !== 'voice' && activeTab !== 'secure-notes' && activeTab !== 'todo'">
                <template x-for="item in sortedItems" :key="item.id">
                    <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 relative group transition-all hover:shadow-md"
                        :class="{ 'opacity-50 dark:opacity-40': item.isDone && activeTab !== 'secure-notes' }"
                        x-transition:leave.opacity.duration.300>

                        <a :href="item.link" target="_blank" @click.stop
                            x-show="!isTodoTab(activeTab) && activeTab !== 'secure-notes' && item.link"
                            class="absolute top-3 right-3 p-2 rounded-full transition-colors z-10 text-blue-500 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-800/50">
                            <i :data-lucide="activeTab === 'music' ? 'music' : 'link'" class="w-5 h-5"></i>
                        </a>

                        <template x-if="isTodoTab(activeTab)">
                            <div class="flex items-start gap-4" @click="openEditItemModal(item)">
                                <div class="mt-1">
                                    <input type="checkbox" :checked="item.isDone"
                                        class="form-checkbox h-6 w-6 text-blue-600 bg-gray-200 dark:bg-gray-700 border-gray-300 rounded focus:ring-blue-500 cursor-pointer transition-colors"
                                        @click.stop="toggleDone(item.id)">
                                </div>
                                <div class="flex-1 min-w-0 cursor-pointer">
                                    <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg leading-snug"
                                        x-text="item.title"
                                        :class="{ 'line-through text-gray-400 dark:text-gray-500': item.isDone }"></h3>
                                    <p x-show="item.note"
                                        class="mt-1 text-sm text-gray-500 dark:text-gray-400 whitespace-pre-line"
                                        x-text="item.note"></p>
                                </div>
                            </div>
                        </template>

                        <template x-if="!isTodoTab(activeTab) && activeTab !== 'secure-notes'">
                            <div @click="openEditItemModal(item)" class="cursor-pointer">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg pr-10 leading-tight"
                                    x-text="item.title" :class="{ 'line-through': item.isDone }"></h3>

                                <div class="mt-3 flex items-center gap-2">
                                </div>

                                <div x-show="item.note"
                                    class="mt-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-lg whitespace-pre-line border border-gray-100 dark:border-gray-700"
                                    x-text="item.note" :class="{ 'line-through': item.isDone }"></div>
                            </div>
                        </template>

                        <div
                            class="mt-3 pt-3 border-t border-gray-50 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-[10px] text-gray-400 dark:text-gray-600"
                                x-text="new Date(item.id).toLocaleDateString()"></span>

                            <div class="flex items-center gap-3">
                                <button @click.stop="toggleFavorite(item.id)"
                                    x-show="!isTodoTab(activeTab) && activeTab !== 'secure-notes'"
                                    class="p-1 rounded-full transition-colors active:scale-95"
                                    :class="item.isFavorite ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-300 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'">
                                    <i data-lucide="heart" class="w-5 h-5"
                                        :fill="item.isFavorite ? 'currentColor' : 'none'"></i>
                                </button>
                                <button @click.stop="toggleDone(item.id)"
                                    class="text-xs font-bold transition-colors py-1 px-2 rounded-full"
                                    x-show="!isTodoTab(activeTab)"
                                    :class="item.isDone ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-300 hover:text-blue-600'">
                                    <i data-lucide="check-circle" class="w-3 h-3 inline-block mr-1"></i>
                                    <span x-text="item.isDone ? 'UNDONE' : 'MARK DONE'"></span>
                                </button>

                                <button @click.stop="confirmDeleteItem(item.id, activeTab)"
                                    class="text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Secure Notes Display -->
            <div x-show="activeTab === 'secure-notes'" class="grid gap-4">
                <template x-for="item in sortedItems" :key="item.id">
                    <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 relative group transition-all hover:shadow-md"
                        x-transition:leave.opacity.duration.300>

                        <div @click="openEditItemModal(item)" class="cursor-pointer">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg pr-10 leading-tight"
                                x-text="item.title"></h3>
                            <div x-show="item.note"
                                class="mt-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-lg whitespace-pre-line border border-gray-100 dark:border-gray-700 flex justify-between items-start">
                                <p class="whitespace-pre-line break-words mr-2" x-text="item.note"></p>
                                <button @click.stop="copyToClipboard(item.note, 'Secure Note')"
                                    class="p-1 flex-shrink-0 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 active:scale-95 transition-transform">
                                    <i data-lucide="copy" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>

                        <div
                            class="mt-3 pt-3 border-t border-gray-50 dark:border-gray-700 flex justify-end items-center">
                            <button @click.stop="confirmDeleteItem(item.id, activeTab)"
                                class="text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <div x-show="sortedItems.length === 0 && activeTab !== 'secure-notes' && activeTab !== 'cards' && activeTab !== 'voice' && activeTab !== 'todo'">
                <div class="flex flex-col items-center justify-center mt-20 text-gray-300 dark:text-gray-600">
                    <i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-50"></i>
                    <p>No items in <span class="font-bold text-gray-400 dark:text-gray-500"
                            x-text="activeTab === 'secure-notes' ? 'Secure Notes' : toTitleCase(activeTab)"></span></p>
                </div>
            </div>

            <div x-show="copyMessage" x-transition.opacity.duration.300
                class="fixed bottom-32 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-xl z-[60] pointer-events-none">
                <span x-text="copyMessage"></span>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <button x-show="currentView === 'tab' && activeTab === 'cards'" @click="openAddCardModal()"
        class="fixed bottom-6 right-6 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-40 ring-2 ring-white dark:ring-gray-800 bg-blue-600 hover:bg-blue-700">
        <i data-lucide="plus" class="w-6 h-6"></i>
    </button>

    <!-- Voice Tab Floating Microphone -->
    <button x-show="currentView === 'tab' && activeTab === 'voice'" @click="startRecording()"
        class="fixed bottom-6 right-6 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-40 ring-2 ring-white dark:ring-gray-800 bg-gradient-to-br from-voice-600 to-indigo-600 hover:from-voice-700 hover:to-indigo-700">
        <i data-lucide="mic" class="w-6 h-6"></i>
    </button>

    <!-- Todo Tab Floating Button -->
    <button x-show="currentView === 'tab' && activeTab === 'todo'" @click="openAddTodoModal()"
        class="fixed bottom-6 right-6 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-40 ring-2 ring-white dark:ring-gray-800 bg-gradient-to-br from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700">
        <i data-lucide="plus" class="w-6 h-6"></i>
    </button>

    <button x-show="currentView === 'tab' && activeTab !== 'cards' && activeTab !== 'voice' && activeTab !== 'todo'" @click="openAddItemModal()"
        class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-40 ring-2 ring-white dark:ring-gray-800">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- Todo Voice Input Modal -->
    <div x-show="modals.todoVoiceInput"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end justify-center p-0" x-transition.opacity
        @click.self="closeTodoVoiceModal()">
        <div
            class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl shadow-2xl animate-slide-up border dark:border-gray-700">
            <div class="flex flex-col items-center p-6">
                <div class="w-full mb-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-2">Add Multiple Tasks</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Say tasks separated by "and" or "then"</p>
                </div>

                <!-- Recording Indicator -->
                <div x-show="isRecording" class="flex flex-col items-center justify-center mb-6">
                    <div class="relative mb-4">
                        <div class="absolute inset-0 rounded-full bg-purple-100 dark:bg-purple-900/30 pulse-ring"></div>
                        <div
                            class="w-16 h-16 bg-purple-500 dark:bg-purple-600 rounded-full flex items-center justify-center relative">
                            <i data-lucide="mic" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>

                    <div class="waveform-minimal">
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                    </div>

                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                        <span class="font-bold text-purple-500" x-text="recordingTime"></span> seconds
                    </p>
                </div>

                <!-- Ready to Record State -->
                <div x-show="!isRecording && !todoVoiceText" class="flex flex-col items-center justify-center mb-6">
                    <div
                        class="w-20 h-20 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mb-4">
                        <i data-lucide="mic" class="w-8 h-8 text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 font-medium">Tap to start recording</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Example: "clean cycle and repair bike and go to temple"</p>
                </div>

                <!-- Transcript Display -->
                <div x-show="todoVoiceText" class="w-full mb-6">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">
                        Tasks will be split by "and" or "then"
                    </label>
                    <div class="relative">
                        <textarea x-model="todoVoiceText" rows="4"
                            class="w-full p-4 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none pr-10 text-sm"
                            placeholder="Your tasks will appear here..." :readonly="isRecording"></textarea>

                        <button x-show="todoVoiceText && !isRecording" @click="todoVoiceText = ''"
                            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <!-- Preview of split tasks -->
                    <div x-show="todoVoiceText && !isRecording" class="mt-4">
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">
                            Preview (<span x-text="getTodoVoiceTaskCount()"></span> tasks)
                        </label>
                        <div class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                            <template x-for="(task, index) in splitTodoVoiceTasks()" :key="index">
                                <div class="flex items-start gap-2 p-2 bg-white dark:bg-gray-700 rounded">
                                    <span class="text-gray-400 dark:text-gray-500 text-sm" x-text="(index + 1) + '.'"></span>
                                    <span class="text-sm text-gray-700 dark:text-gray-300" x-text="task"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col w-full gap-3">
                    <!-- Start/Stop Recording Button -->
                    <button x-show="!isRecording" @click="startTodoRecording()"
                        class="flex items-center justify-center gap-2 py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 active:scale-95 transition-transform w-full">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                        <span x-text="todoVoiceText ? 'Record Again' : 'Start Recording'"></span>
                    </button>

                    <button x-show="isRecording" @click="stopRecording()"
                        class="flex items-center justify-center gap-2 py-4 bg-red-500 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-red-600 active:scale-95 transition-transform w-full">
                        <i data-lucide="square" class="w-5 h-5"></i>
                        Stop Recording
                    </button>

                    <!-- Save Button -->
                    <button x-show="todoVoiceText && !isRecording" @click="saveTodoVoiceTasks()"
                        class="flex items-center justify-center gap-2 py-4 bg-green-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-green-700 active:scale-95 transition-transform w-full">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Save <span x-text="getTodoVoiceTaskCount()"></span> Tasks
                    </button>
                </div>

                <!-- Close Button -->
                <button @click="closeTodoVoiceModal()"
                    class="mt-4 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Minimal Voice Input Modal -->
    <div x-show="modals.voiceInput"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end justify-center p-0" x-transition.opacity
        @click.self="closeVoiceModal()">
        <div
            class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl shadow-2xl animate-slide-up border dark:border-gray-700">
            <div class="flex flex-col items-center p-6">
                <!-- Recording Indicator -->
                <div x-show="isRecording" class="flex flex-col items-center justify-center mb-4">
                    <div class="relative mb-3">
                        <div class="absolute inset-0 rounded-full bg-red-100 dark:bg-red-900/30 pulse-ring"></div>
                        <div
                            class="w-16 h-16 bg-red-500 dark:bg-red-600 rounded-full flex items-center justify-center relative">
                            <i data-lucide="mic" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>

                    <div class="waveform-minimal">
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                        <div class="waveform-bar-minimal"></div>
                    </div>

                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                        <span class="font-bold text-red-500" x-text="recordingTime"></span> seconds
                    </p>
                </div>

                <!-- Ready to Record State -->
                <div x-show="!isRecording && !voiceText" class="flex flex-col items-center justify-center mb-6">
                    <div
                        class="w-20 h-20 rounded-full bg-voice-100 dark:bg-voice-900/30 flex items-center justify-center mb-4">
                        <i data-lucide="mic" class="w-8 h-8 text-voice-600 dark:text-voice-400"></i>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 font-medium">Tap to start recording</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Speak clearly into your microphone</p>
                </div>

                <!-- Transcript Display -->
                <div x-show="voiceText" class="w-full mb-6">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">
                        Transcript
                    </label>
                    <div class="relative">
                        <textarea x-model="voiceText" rows="4"
                            class="w-full p-4 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-voice-500 outline-none pr-10 text-sm"
                            placeholder="Your voice note will appear here..." :readonly="isRecording"></textarea>

                        <button x-show="voiceText && !isRecording" @click="voiceText = ''"
                            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col w-full gap-3">
                    <!-- Start/Stop Recording Button -->
                    <button x-show="!isRecording" @click="startRecording()"
                        class="flex items-center justify-center gap-2 py-4 bg-voice-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-voice-700 active:scale-95 transition-transform w-full">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                        <span x-text="voiceText ? 'Record Again' : 'Start Recording'"></span>
                    </button>

                    <button x-show="isRecording" @click="stopRecording()"
                        class="flex items-center justify-center gap-2 py-4 bg-red-500 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-red-600 active:scale-95 transition-transform w-full">
                        <i data-lucide="square" class="w-5 h-5"></i>
                        Stop Recording
                    </button>

                    <!-- Save Button -->
                    <button x-show="voiceText && !isRecording" @click="saveVoiceNote()"
                        class="flex items-center justify-center gap-2 py-4 bg-green-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-green-700 active:scale-95 transition-transform w-full">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Save Voice Note
                    </button>
                </div>

                <!-- Close Button -->
                <button @click="closeVoiceModal()"
                    class="mt-4 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div x-show="modals.item"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white" x-text="editingItem ? 'Edit Item' : 'Add New Item'"></h2>
                <button @click="modals.item = false" class="text-gray-400"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <div x-show="activeTab !== 'voice'">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Title</label>
                    <input type="text" x-model="form.title"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        :placeholder="getTitlePlaceholder()">
                </div>
                <template x-if="activeTab !== 'secure-notes' && !isTodoTab(activeTab) && activeTab !== 'voice'">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Link</label>
                        <div class="flex items-center gap-2">
                            <input type="text" x-model="form.link"
                                class="flex-1 p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                :placeholder="getLinkPlaceholder()">
                            <button x-show="activeTab === 'music'" @click.prevent="generateLinkForMusic()"
                                :disabled="!form.title.trim()"
                                class="bg-blue-600 text-white font-bold text-xs px-4 py-3 rounded-xl shadow-md transition-colors hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Auto
                            </button>
                        </div>
                    </div>
                </template>
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1"
                        x-text="getNoteLabel()"></label>
                    <textarea x-model="form.note" rows="5"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        :placeholder="getNotePlaceholder()"></textarea>
                </div>
            </div>

            <button @click="saveItem()"
                class="w-full mt-6 py-3.5 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform hover:bg-blue-700"
                :disabled="!form.title.trim() && activeTab !== 'voice'">
                <span x-text="editingItem ? 'Save Changes' : 'Save Item'"></span>
            </button>
        </div>
    </div>

    <!-- Todo Item Modal -->
    <div x-show="modals.todoItem"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white" x-text="editingTodo ? 'Edit Task' : 'Add New Task'"></h2>
                <button @click="modals.todoItem = false" class="text-gray-400"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Task Title</label>
                    <input type="text" x-model="todoForm.title"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. Buy groceries">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Notes (Optional)</label>
                    <textarea x-model="todoForm.note" rows="3"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Add any extra details..."></textarea>
                </div>
            </div>

            <button @click="saveTodoItem()"
                class="w-full mt-6 py-3.5 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform hover:bg-purple-700"
                :disabled="!todoForm.title.trim()">
                <span x-text="editingTodo ? 'Save Changes' : 'Save Task'"></span>
            </button>
        </div>
    </div>

    <div x-show="modals.cardItem"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl animate-slide-up border dark:border-gray-700 flex flex-col max-h-[90vh]">

            <div class="flex justify-between items-center p-6 pb-4 flex-shrink-0">
                <h2 class="text-xl font-bold dark:text-white" x-text="editingCard ? 'Edit Card' : 'Add New Card'"></h2>
                <button @click="modals.cardItem = false" class="text-gray-400"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div class="overflow-y-auto px-6 flex-1">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Card Name
                            / Title</label>
                        <input type="text" x-model="cardForm.title"
                            class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="e.g. Amazon Card">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Card
                            Number</label>
                        <input type="text" x-model="cardForm.number" inputmode="numeric" pattern="[0-9\s]{13,19}"
                            maxlength="19"
                            class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="XXXX XXXX XXXX XXXX">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Card
                            Holder Name</label>
                        <input type="text" x-model="cardForm.holder"
                            class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="JANE DOE">
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Expiry
                                (MM/YY)</label>
                            <input type="text" x-model="cardForm.expiry" maxlength="5"
                                @input="cardForm.expiry = formatExpiryInput($event.target.value)" x-ref="expiryInput"
                                class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="12/25">
                        </div>
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">CVV/CVC</label>
                            <input type="text" x-model="cardForm.cvv" inputmode="numeric" maxlength="4" x-ref="cvvInput"
                                class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="***">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Card
                            Color</label>
                        <div
                            class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl">
                            <input type="color" x-model="cardForm.color"
                                class="w-8 h-8 rounded-md cursor-pointer border-none p-0 appearance-none bg-transparent">
                            <span class="text-sm font-medium dark:text-white" x-text="cardForm.color"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Secure
                            Note (Optional)</label>
                        <textarea x-model="cardForm.note" rows="3"
                            class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="Add any extra, sensitive notes here..."></textarea>
                    </div>
                </div>
            </div>

            <div class="p-6 pt-4 flex-shrink-0">
                <button @click="saveCard()"
                    class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform hover:bg-blue-700"
                    :disabled="!cardForm.number.trim()">
                    Save Card
                </button>
            </div>
        </div>
    </div>

    <div x-show="modals.delete" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div
                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white"
                x-text="itemToDelete && getItemType(itemToDelete) === 'card' ? 'Delete this card?' : 'Delete this item?'">
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button @click="modals.delete = false"
                    class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="performDelete()"
                    class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <div x-show="modals.tab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-xl dark:border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Create New Tab</h2>
                <button @click="modals.tab = false" class="text-gray-400"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Tab
                        Name</label>
                    <input type="text" x-model="newTabName" @keydown.enter.prevent="createNewTab()"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. Reading List">
                    <p x-show="newTabError" x-text="newTabError" class="text-sm text-red-500 mt-2 transition-opacity">
                    </p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Tab
                        Type</label>
                    <div
                        class="flex gap-4 p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl">
                        <label class="flex items-center text-sm font-medium dark:text-white cursor-pointer">
                            <input type="radio" x-model="newTabType" value="normal" name="tab-type"
                                class="form-radio h-4 w-4 text-blue-600 dark:bg-gray-700 border-gray-300 focus:ring-blue-500 mr-2"
                                checked>
                            Normal (Link/Note)
                        </label>
                        <label class="flex items-center text-sm font-medium dark:text-white cursor-pointer">
                            <input type="radio" x-model="newTabType" value="todo" name="tab-type"
                                class="form-radio h-4 w-4 text-blue-600 dark:bg-gray-700 border-gray-300 focus:ring-blue-500 mr-2">
                            To-Do List
                        </label>
                    </div>
                </div>
            </div>

            <button @click="createNewTab()" :disabled="!newTabName.trim()"
                class="w-full mt-6 py-3.5 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform hover:bg-blue-700 disabled:opacity-50">
                Create Tab
            </button>
        </div>
    </div>

    <div x-show="modals.editTab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-xl dark:border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Rename Tab</h2>
                <button @click="modals.editTab = false" class="text-gray-400"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">New
                        Name</label>
                    <input type="text" x-model="editTabName" @keydown.enter.prevent="saveTabRename()"
                        class="w-full p-3 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        :placeholder="toTitleCase(currentContextTab)">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="modals.editTab = false"
                    class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="saveTabRename()"
                    class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Rename</button>
            </div>
        </div>
    </div>

    <div x-show="modals.deleteTab" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div
                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">Delete the '<span
                    x-text="toTitleCase(currentContextTab)"></span>' tab?</h3>
            <p class="text-sm text-red-500 mb-6 font-bold">WARNING: All items in this tab will be permanently lost.</p>
            <div class="flex gap-3">
                <button @click="modals.deleteTab = false"
                    class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="performTabDelete()"
                    class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="modals.settings" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl shadow-xl dark:border dark:border-gray-700 flex flex-col max-h-[80vh]">
            <div
                class="flex justify-between items-center p-6 pb-4 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                <h2 class="text-xl font-bold dark:text-white">App Settings</h2>
                <button @click="modals.settings = false" class="text-gray-400">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="overflow-y-auto px-6 flex-1">
                <!-- Default Launch View Settings -->
                <div class="mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <h3 class="font-bold text-md mb-2">Default Launch View</h3>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-medium dark:text-white cursor-pointer">
                            <input type="radio" x-model="tempDefaultView" value="home" name="default-view"
                                class="form-radio h-4 w-4 text-blue-600 dark:bg-gray-700 border-gray-300 focus:ring-blue-500 mr-2">
                            Home Dashboard
                        </label>
                        <label class="flex items-center text-sm font-medium dark:text-white cursor-pointer">
                            <input type="radio" x-model="tempDefaultView" value="tab" name="default-view"
                                class="form-radio h-4 w-4 text-blue-600 dark:bg-gray-700 border-gray-300 focus:ring-blue-500 mr-2">
                            Specific Tab
                        </label>

                        <div x-show="tempDefaultView === 'tab'" class="mt-2">
                            <select x-model="tempDefaultTabID"
                                class="w-full p-2 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                <template x-for="tab in tabs">
                                    <template x-if="tab !== 'secure-notes' && tab !== 'cards' && tab !== 'voice' && tab !== 'todo'">
                                        <option :value="tab" x-text="toTitleCase(tab)"></option>
                                    </template>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Voice Notes Settings -->
                <div class="mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <h3 class="font-bold text-md mb-2">Voice Notes Settings</h3>
                    <div class="space-y-2">
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Language</label>
                            <select x-model="tempVoiceLanguage"
                                class="w-full p-2 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="es-ES">Spanish</option>
                                <option value="fr-FR">French</option>
                                <option value="de-DE">German</option>
                            </select>
                        </div>

                        <label class="flex items-center text-sm font-medium dark:text-white cursor-pointer">
                            <input type="checkbox" x-model="tempAutoSaveVoiceNotes" name="auto-save-voice"
                                class="form-checkbox h-4 w-4 text-blue-600 dark:bg-gray-700 border-gray-300 focus:ring-blue-500 mr-2">
                            Auto-save voice notes
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Works best in Chrome/Edge browsers.</p>
                </div>

                <!-- Theme Settings -->
                <div class="mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-md mb-0.5">Theme</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Switch between light and dark mode</p>
                        </div>
                        <button @click="toggleTheme()"
                            class="p-3 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors active:scale-95">
                            <i x-show="darkMode" data-lucide="sun" class="w-5 h-5 text-yellow-500"></i>
                            <i x-show="!darkMode" data-lucide="moon" class="w-5 h-5 text-blue-500"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <h3 class="font-bold text-md mb-2">Music Link Preference</h3>
                    <select x-model="tempMusicAppPreference"
                        class="w-full p-2 bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <option value="youtube_music">YouTube Music</option>
                        <option value="spotify">Spotify</option>
                        <option value="apple_music">Apple Music</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Applies to all new items in the Music tab.
                    </p>
                </div>

                <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center text-xs text-gray-400 dark:text-gray-600">
                        <span>Version <span x-text="version"></span></span>
                        <span x-show="updateAvailable"
                            class="text-blue-500 dark:text-blue-400 font-bold flex items-center gap-1">
                            Update Available!
                        </span>
                    </div>
                </div>
            </div>

            <!-- Fixed Save Button -->
            <div class="p-6 pt-4 flex-shrink-0 border-t border-gray-100 dark:border-gray-700">
                <button @click="savePreferences()"
                    :disabled="tempDefaultTabID === defaultTabID && tempMusicAppPreference === musicAppPreference && tempDefaultView === defaultView && tempVoiceLanguage === voiceLanguage && tempAutoSaveVoiceNotes === autoSaveVoiceNotes"
                    class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-md shadow-lg active:scale-95 transition-transform hover:bg-blue-700 disabled:opacity-50">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <div x-show="modals.deleteAll" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div
                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="skull" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">Delete ALL App Data?</h3>
            <p class="text-sm text-red-500 mb-6 font-bold">This includes all items, tabs, and preferences. THIS
                CANNOT
                BE UNDONE.</p>
            <div class="flex gap-3">
                <button @click="modals.deleteAll = false"
                    class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-xl font-bold text-gray-600 dark:text-gray-300">Cancel</button>
                <button @click="performDeleteAllData()"
                    class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600">DELETE
                    ALL</button>
            </div>
        </div>
    </div>

    <div x-show="modals.update" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
        x-transition.opacity>
        <div
            class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 text-center shadow-xl dark:border dark:border-gray-700">
            <div
                class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="cloud-download" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">App Update Ready!</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">A new version is available. Restart the app to
                apply the update.</p>
            <button @click="reloadApp()"
                class="bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-500">Update</button>
        </div>
    </div>

    <div x-show="modals.tabContext" x-cloak :style="{ left: contextMenuX + 'px', top: contextMenuY + 'px' }"
        @click.outside="modals.tabContext = false"
        class="fixed bg-white dark:bg-gray-800 rounded-lg shadow-xl p-2 z-[60] text-sm animate-scale-in border border-gray-100 dark:border-gray-700">
        <ul class="space-y-1 w-32">
            <li>
                <button @click="modals.tabContext = false; openEditTabModal()"
                    class="w-full text-left px-3 py-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                    Rename
                </button>
            </li>
            <li>
                <button @click="modals.tabContext = false; confirmDeleteTab(currentContextTab)"
                    class="w-full text-left px-3 py-2 rounded-md text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Delete
                </button>
            </li>
        </ul>
    </div>

    <script>
        function app() {
            return {
                version: '4.5.0',

                // Voice Input State
                isRecording: false,
                voiceText: '',
                todoVoiceText: '',
                recognition: null,
                recordingTime: 0,
                recordingTimer: null,
                voiceLanguage: 'en-US',
                autoSaveVoiceNotes: false,
                tempVoiceLanguage: 'en-US',
                tempAutoSaveVoiceNotes: false,
                finalTranscript: '',
                interimTranscript: '',

                // New state for Home Dashboard
                currentView: 'home',
                defaultView: localStorage.getItem('bd_default_view') || 'home',
                tempDefaultView: localStorage.getItem('bd_default_view') || 'home',

                // Existing states
                activeTab: 'food',
                longPressActive: false,
                homeLongPressActive: false,
                longPressTimer: null,
                homeLongPressTimer: null,
                longPressDuration: 500,
                tabs: ['food', 'travel', 'movies', 'music', 'todo', 'voice', 'secure-notes', 'cards'],
                data: {},
                musicAppPreference: 'youtube_music',
                oldMusicAppPreference: 'youtube_music',
                tabMetadata: {},
                defaultTabID: localStorage.getItem('bd_default_tab') || 'food',
                darkMode: false,
                newTabError: '',
                tempDefaultTabID: 'food',
                tempMusicAppPreference: 'youtube_music',
                touchstartX: 0,
                touchendX: 0,
                swipeThreshold: 75,
                currentContextTab: null,
                contextMenuX: 0,
                contextMenuY: 0,
                copyMessage: null,
                copyTimer: null,
                
                // Todo specific states
                showPreviousDays: false,
                todoForm: {
                    id: null,
                    title: '',
                    note: '',
                    date: 'today',
                    isDone: false,
                    isFavorite: false,
                    type: 'todo'
                },
                editingTodo: false,
                
                modals: {
                    item: false,
                    tab: false,
                    editTab: false,
                    delete: false,
                    deleteTab: false,
                    tabContext: false,
                    settings: false,
                    cardItem: false,
                    deleteAll: false,
                    update: false,
                    voiceInput: false,
                    todoVoiceInput: false,
                    todoItem: false
                },
                updateAvailable: false,
                waitingWorker: null,
                form: {
                    id: null,
                    title: '',
                    link: '',
                    note: '',
                    isFavorite: false,
                    isDone: false,
                    type: 'note'
                },
                editingItem: false,
                cardForm: {
                    id: null,
                    title: '',
                    number: '',
                    holder: '',
                    expiry: '',
                    cvv: '',
                    color: '#2563eb',
                    type: 'card',
                    note: ''
                },
                editingCard: false,
                newTabName: '',
                newTabType: 'normal',
                editTabName: '',
                itemToDelete: null,
                tabToDelete: null,
                ANIMATION_DURATION: 300,

                init() {
                    // 1. Initialize Theme
                    const savedTheme = localStorage.getItem('bd_theme');
                    if (savedTheme) {
                        this.darkMode = savedTheme === 'dark';
                    } else {
                        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                            this.darkMode = true;
                        }
                    }

                    // 2. Load Data and Preferences
                    const sData = localStorage.getItem('bd_data');
                    const sTabs = localStorage.getItem('bd_tabs');
                    const sMusicApp = localStorage.getItem('bd_music_app');
                    const sTabMeta = localStorage.getItem('bd_tab_metadata');

                    this.data = sData ? JSON.parse(sData) : {};
                    this.tabs = sTabs ? JSON.parse(sTabs) : ['food', 'travel', 'movies', 'music', 'todo', 'voice', 'secure-notes', 'cards'];
                    this.tabMetadata = sTabMeta ? JSON.parse(sTabMeta) : {};

                    // Initialize todo tab if it doesn't exist
                    if (!this.data['todo']) {
                        this.data['todo'] = [];
                    }
                    
                    // Initialize voice tab if it doesn't exist
                    if (!this.data['voice']) {
                        this.data['voice'] = [];
                    }

                    // Migrate old secure data to new structure
                    this.migrateSecureData();

                    if (sMusicApp) {
                        this.musicAppPreference = sMusicApp;
                        this.oldMusicAppPreference = sMusicApp;
                    }

                    this.migrateOldData();

                    // 3. Load voice preferences
                    const sVoiceLanguage = localStorage.getItem('bd_voice_language');
                    const sAutoSaveVoice = localStorage.getItem('bd_auto_save_voice');

                    if (sVoiceLanguage) {
                        this.voiceLanguage = sVoiceLanguage;
                        this.tempVoiceLanguage = sVoiceLanguage;
                    }
                    if (sAutoSaveVoice) {
                        this.autoSaveVoiceNotes = sAutoSaveVoice === 'true';
                        this.tempAutoSaveVoiceNotes = sAutoSaveVoice === 'true';
                    }

                    // 4. Load view preferences
                    const sDefaultView = localStorage.getItem('bd_default_view');
                    if (sDefaultView) {
                        this.defaultView = sDefaultView;
                        this.tempDefaultView = sDefaultView;
                    }

                    // Robust Default View Logic
                    if (this.defaultView === 'tab') {
                        this.currentView = 'tab';
                        this.activeTab = this.defaultTabID;
                    } else {
                        this.currentView = 'home';
                        const lastActiveTab = localStorage.getItem('bd_last_active_tab');
                        if (lastActiveTab && this.tabs.includes(lastActiveTab)) {
                            this.activeTab = lastActiveTab;
                        }
                    }

                    // 5. Ensure active tab exists
                    if (!this.tabs.includes(this.activeTab)) {
                        this.activeTab = this.defaultTabID;
                    }

                    // 6. Initialize Speech Recognition if available
                    this.initializeSpeechRecognition();

                    // 7. Set up History API for back button navigation
                    this.setupHistoryNavigation();

                    // 8. Alpine.js Watchers
                    this.$watch('activeTab', (newTab) => {
                        if (this.currentView === 'tab') {
                            localStorage.setItem('bd_last_active_tab', newTab);
                            this.updateHistoryState(newTab);
                        }
                        this.$nextTick(() => {
                            lucide.createIcons();
                        });
                    });
                    this.$watch('darkMode', () => {
                        this.$nextTick(() => lucide.createIcons());
                    });

                    // 9. Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('sw.js').then(reg => {
                            reg.addEventListener('waiting', () => {
                                this.updateAvailable = true;
                                this.waitingWorker = reg.waiting;
                            });
                        });
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            window.location.reload();
                        });
                    }

                    // 10. Process old to-do items (move undone tasks to today)
                    this.processOldTodoItems();

                    this.$nextTick(() => lucide.createIcons());
                },

                // FIX 1: Initialize icons after data changes
                initializeIconsAfterUpdate() {
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                },

                // Todo Tab Methods
                getTodoCount() {
                    return (this.data['todo'] || []).length;
                },

                getTodoUndoneCount() {
                    return (this.data['todo'] || []).filter(item => !item.isDone).length;
                },

                getTodayTodoCount() {
                    const today = new Date().toISOString().split('T')[0];
                    return (this.data['todo'] || []).filter(item => this.isToday(item.date) && !item.isDone).length;
                },

                getPreviousDaysTodoCount() {
                    return (this.data['todo'] || []).filter(item => !this.isToday(item.date)).length;
                },

                get sortedTodoItems() {
                    let items = this.data['todo'] || [];
                    return items.sort((a, b) => {
                        // Sort by date (today first), then by done status, then by favorite, then by id
                        const aIsToday = this.isToday(a.date);
                        const bIsToday = this.isToday(b.date);
                        
                        if (aIsToday !== bIsToday) {
                            return aIsToday ? -1 : 1;
                        }
                        
                        if (a.isDone !== b.isDone) {
                            return a.isDone ? 1 : -1;
                        }
                        
                        if (a.isFavorite !== b.isFavorite) {
                            return a.isFavorite ? -1 : 1;
                        }
                        
                        return b.id - a.id;
                    });
                },

                isToday(dateString) {
                    if (!dateString || dateString === 'today') return true;
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Handle date strings that might be in different formats
                    if (dateString === today) return true;
                    
                    // Try to parse the date
                    try {
                        const date = new Date(dateString);
                        const dateFormatted = date.toISOString().split('T')[0];
                        return dateFormatted === today;
                    } catch {
                        return false;
                    }
                },

                formatTodoDate(dateString) {
                    if (!dateString || dateString === 'today') return 'Today';
                    
                    try {
                        const date = new Date(dateString);
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (date.toDateString() === today.toDateString()) {
                            return 'Today';
                        } else if (date.toDateString() === yesterday.toDateString()) {
                            return 'Yesterday';
                        } else {
                            return date.toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    } catch {
                        return dateString;
                    }
                },

                processOldTodoItems() {
                    const items = this.data['todo'] || [];
                    const today = new Date().toISOString().split('T')[0];
                    let changed = false;
                    
                    items.forEach(item => {
                        // If item doesn't have a date, set it to today
                        if (!item.date) {
                            item.date = today;
                            changed = true;
                        }
                        // If item is not done and date is in the past, move to today
                        else if (!item.isDone && !this.isToday(item.date)) {
                            // Check if date is in the past
                            try {
                                const itemDate = new Date(item.date);
                                const todayDate = new Date(today);
                                if (itemDate < todayDate) {
                                    item.date = today;
                                    changed = true;
                                }
                            } catch (e) {
                                // If date parsing fails, move to today
                                item.date = today;
                                changed = true;
                            }
                        }
                    });
                    
                    if (changed) {
                        this.persist();
                    }
                },

                openAddTodoModal() {
                    this.editingTodo = false;
                    this.todoForm = {
                        id: Date.now(),
                        title: '',
                        note: '',
                        date: 'today',
                        isDone: false,
                        isFavorite: false,
                        type: 'todo'
                    };
                    this.modals.todoItem = true;
                    this.initializeIconsAfterUpdate();
                },

                openEditTodoModal(item) {
                    this.editingTodo = true;
                    this.todoForm = {
                        id: item.id,
                        title: item.title,
                        note: item.note || '',
                        date: item.date || 'today',
                        isDone: item.isDone || false,
                        isFavorite: item.isFavorite || false,
                        type: 'todo'
                    };
                    this.modals.todoItem = true;
                    this.initializeIconsAfterUpdate();
                },

                saveTodoItem() {
                    if (!this.todoForm.title.trim()) {
                        this.showCopyToast('Please enter a task title');
                        return;
                    }

                    // Convert 'today' to actual date string
                    if (this.todoForm.date === 'today') {
                        this.todoForm.date = new Date().toISOString().split('T')[0];
                    }

                    let list = this.data['todo'] || [];

                    if (this.editingTodo) {
                        const index = list.findIndex(i => i.id === this.todoForm.id);
                        if (index !== -1) {
                            list[index] = { ...this.todoForm };
                        }
                    } else {
                        this.todoForm.id = Date.now();
                        list.unshift(this.todoForm);
                    }

                    this.data['todo'] = list;
                    this.persist();
                    this.modals.todoItem = false;
                    
                    // FIX 1: Initialize icons after save
                    this.initializeIconsAfterUpdate();
                    
                    this.showCopyToast(this.editingTodo ? 'Task updated!' : 'Task added!');
                },

                toggleTodoDone(id) {
                    const item = (this.data['todo'] || []).find(i => i.id === id);
                    if (item) {
                        item.isDone = !item.isDone;
                        this.persist();
                        
                        // FIX 1: Initialize icons after toggle
                        this.initializeIconsAfterUpdate();
                    }
                },

                toggleTodoFavorite(id) {
                    const item = (this.data['todo'] || []).find(i => i.id === id);
                    if (item) {
                        item.isFavorite = !item.isFavorite;
                        this.persist();
                        
                        // FIX 1: Initialize icons after toggle
                        this.initializeIconsAfterUpdate();
                    }
                },

                moveTodoToToday(id) {
                    const item = (this.data['todo'] || []).find(i => i.id === id);
                    if (item) {
                        item.date = new Date().toISOString().split('T')[0];
                        this.persist();
                        this.initializeIconsAfterUpdate();
                        this.showCopyToast('Task moved to today!');
                    }
                },

                openTodoVoiceModal() {
                    this.todoVoiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                    this.modals.todoVoiceInput = true;
                    this.initializeIconsAfterUpdate();
                },

                closeTodoVoiceModal() {
                    if (this.isRecording) {
                        this.stopRecording();
                    }
                    this.modals.todoVoiceInput = false;
                    this.todoVoiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                },

                startTodoRecording() {
                    this.startActualRecording('todo');
                },

                splitTodoVoiceTasks() {
                    if (!this.todoVoiceText.trim()) return [];
                    
                    // Split by common separators: and, then, comma, period, new line
                    const separators = /\s+(?:and|then|,|\.|\n)\s+/gi;
                    const tasks = this.todoVoiceText.split(separators);
                    
                    // Clean up each task
                    return tasks
                        .map(task => task.trim())
                        .filter(task => task.length > 0)
                        .map(task => {
                            // Capitalize first letter
                            return task.charAt(0).toUpperCase() + task.slice(1);
                        });
                },

                getTodoVoiceTaskCount() {
                    return this.splitTodoVoiceTasks().length;
                },

                saveTodoVoiceTasks() {
                    const tasks = this.splitTodoVoiceTasks();
                    
                    if (tasks.length === 0) {
                        this.showCopyToast('No tasks to save');
                        return;
                    }

                    const today = new Date().toISOString().split('T')[0];
                    let list = this.data['todo'] || [];
                    
                    // Add each task
                    tasks.forEach((task, index) => {
                        const taskId = Date.now() + index; // Ensure unique IDs
                        const taskItem = {
                            id: taskId,
                            title: task,
                            note: '',
                            date: today,
                            isDone: false,
                            isFavorite: false,
                            type: 'todo'
                        };
                        list.unshift(taskItem);
                    });

                    this.data['todo'] = list;
                    this.persist();
                    this.modals.todoVoiceInput = false;
                    
                    // FIX 1: Initialize icons after save
                    this.initializeIconsAfterUpdate();
                    
                    this.showCopyToast(`Saved ${tasks.length} tasks!`);
                    this.todoVoiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                },

                // Updated existing methods for icon initialization
                saveItem() {
                    let list = this.data[this.activeTab] || [];

                    // Validation
                    if (this.activeTab === 'voice') {
                        if (!this.form.note.trim()) {
                            this.showCopyToast('Please enter a note');
                            return;
                        }
                    } else if (this.activeTab !== 'secure-notes') {
                        if (!this.form.title.trim()) {
                            this.showCopyToast('Please enter a title');
                            return;
                        }
                    }

                    if (this.activeTab !== 'secure-notes' && !this.isTodoTab(this.activeTab) && this.activeTab !== 'voice' && (!this.form.link || !this.form.link.trim()) && this.form.title.trim()) {
                        if (this.activeTab === 'food') {
                            this.form.link = this.autoGenerateYouTubeSearchLink(this.form.title);
                        } else if (this.activeTab !== 'music') {
                            this.form.link = this.autoGenerateGoogleSearchLink(this.form.title);
                        }
                    }

                    if (this.activeTab === 'secure-notes') {
                        this.form.link = '';
                        this.form.isDone = false;
                        this.form.isFavorite = false;
                        this.form.type = 'note';
                    }

                    if (this.activeTab === 'voice') {
                        this.form.link = '';
                        this.form.type = 'note';
                    }

                    if (this.editingItem) {
                        const index = list.findIndex(i => i.id === this.form.id);
                        if (index !== -1) {
                            const oldItem = list[index];
                            list[index] = { ...oldItem, ...this.form };
                        }
                    } else {
                        this.form.id = Date.now();

                        if (!this.form.link && this.activeTab !== 'secure-notes' && this.activeTab !== 'voice') {
                            this.form.link = this.autoGenerateMusicLink(this.form.title);
                        }
                        list.unshift(this.form);
                    }

                    this.data[this.activeTab] = list;
                    this.persist();
                    this.modals.item = false;
                    
                    // FIX 1: Initialize icons after save
                    this.initializeIconsAfterUpdate();
                    
                    this.showCopyToast(this.editingItem ? 'Item updated!' : 'Item saved!');
                },

                saveCard() {
                    if (!this.cardForm.number) return;

                    this.cardForm.number = this.cardForm.number.replace(/\s/g, '');
                    this.cardForm.expiry = this.cardForm.expiry.replace('/', '').slice(0, 4);
                    this.cardForm.cvv = this.cardForm.cvv.slice(0, 4);

                    let cardData = this.data['cards'] || [];

                    if (this.editingCard) {
                        const index = cardData.findIndex(i => i.id === this.cardForm.id);
                        if (index !== -1) {
                            cardData[index] = { ...this.cardForm };
                        }
                    } else {
                        cardData.unshift(this.cardForm);
                    }

                    this.data['cards'] = cardData;
                    this.persist();
                    this.modals.cardItem = false;
                    this.initializeIconsAfterUpdate();
                },

                saveVoiceNote() {
                    if (!this.voiceText.trim()) {
                        this.showCopyToast('No text to save.');
                        return;
                    }

                    const noteId = Date.now();
                    const noteItem = {
                        id: noteId,
                        title: '',
                        note: this.voiceText.trim(),
                        link: '',
                        isFavorite: false,
                        isDone: false,
                        type: 'note'
                    };

                    let list = this.data['voice'] || [];
                    list.unshift(noteItem);
                    this.data['voice'] = list;

                    this.persist();

                    this.modals.voiceInput = false;
                    this.initializeIconsAfterUpdate();
                    this.showCopyToast('Voice note saved successfully!');
                    this.voiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                },

                // Updated delete method
                confirmDeleteItem(id, tab) {
                    this.itemToDelete = {id: id, tab: tab};
                    this.modals.delete = true;
                },

                performDelete() {
                    if (this.itemToDelete) {
                        this.modals.delete = false;
                        setTimeout(() => {
                            const tabData = this.data[this.itemToDelete.tab];
                            if (tabData && tabData.some(i => i.id === this.itemToDelete.id)) {
                                this.data[this.itemToDelete.tab] = tabData.filter(i => i.id !== this.itemToDelete.id);
                                this.persist();
                                this.initializeIconsAfterUpdate();
                            }
                            this.itemToDelete = null;
                        }, this.ANIMATION_DURATION);
                    }
                },

                toggleFavorite(id) {
                    const item = (this.data[this.activeTab] || []).find(i => i.id === id);
                    if (item && this.activeTab !== 'secure-notes') {
                        item.isFavorite = !item.isFavorite;
                        this.persist();
                        this.initializeIconsAfterUpdate();
                    }
                },

                toggleDone(id) {
                    const item = (this.data[this.activeTab] || []).find(i => i.id === id);
                    if (item && this.activeTab !== 'secure-notes') {
                        item.isDone = !item.isDone;
                        this.persist();
                        this.initializeIconsAfterUpdate();
                    }
                },

                // Updated getTabIcon to include todo
                getTabIcon(tab) {
                    const iconMap = {
                        'food': 'utensils',
                        'travel': 'map-pin',
                        'movies': 'film',
                        'music': 'music',
                        'todo': 'check-square',
                        'voice': 'mic',
                        'secure-notes': 'lock',
                        'cards': 'credit-card',
                        'books': 'book',
                        'reading': 'book-open',
                        'shopping': 'shopping-cart',
                        'work': 'briefcase',
                        'health': 'heart',
                        'fitness': 'dumbbell',
                        'ideas': 'lightbulb',
                        'projects': 'folder-kanban'
                    };
                    return iconMap[tab] || 'folder';
                },

                // Updated getTabCount to handle todo tab
                getTabCount(tab) {
                    const items = this.data[tab] || [];
                    if (this.isTodoTab(tab)) {
                        return items.filter(item => !item.isDone).length;
                    }
                    if (tab === 'voice') {
                        return items.filter(item => !item.isDone).length;
                    }
                    return items.length;
                },

                // Updated sortedItems getter
                get sortedItems() {
                    let items = this.data[this.activeTab] || [];

                    if (this.activeTab === 'secure-notes') {
                        return items.filter(item => item.type !== 'card').sort((a, b) => b.id - a.id);
                    }

                    if (this.activeTab === 'voice') {
                        return items.sort((a, b) => {
                            if (a.isDone !== b.isDone) {
                                return a.isDone ? 1 : -1;
                            }

                            if (a.isFavorite !== b.isFavorite) {
                                return a.isFavorite ? -1 : 1;
                            }

                            return b.id - a.id;
                        });
                    }

                    return items.sort((a, b) => {
                        const isTodo = this.isTodoTab(this.activeTab);

                        if (a.isDone !== b.isDone) {
                            return a.isDone ? 1 : -1;
                        }

                        if (a.isFavorite !== b.isFavorite) {
                            return a.isFavorite ? -1 : 1;
                        }

                        return b.id - a.id;
                    });
                },

                // Voice recording functions
                initializeSpeechRecognition() {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                    if (SpeechRecognition) {
                        this.recognition = new SpeechRecognition();
                        this.recognition.continuous = true;
                        this.recognition.interimResults = true;
                        this.recognition.lang = this.voiceLanguage;

                        this.finalTranscript = '';
                        this.interimTranscript = '';

                        this.recognition.onresult = (event) => {
                            let interimTranscript = '';
                            let newFinalTranscript = '';

                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                const transcript = event.results[i][0].transcript;
                                if (event.results[i].isFinal) {
                                    if (newFinalTranscript.indexOf(transcript) === -1) {
                                        newFinalTranscript += transcript + ' ';
                                    }
                                } else {
                                    interimTranscript += transcript;
                                }
                            }

                            if (newFinalTranscript) {
                                const newWords = newFinalTranscript.trim().split(' ');
                                const existingWords = this.finalTranscript.trim().split(' ');

                                const uniqueNewWords = newWords.filter(word =>
                                    !existingWords.some(existingWord =>
                                        existingWord.toLowerCase() === word.toLowerCase()
                                    )
                                );

                                if (uniqueNewWords.length > 0) {
                                    this.finalTranscript += uniqueNewWords.join(' ') + ' ';
                                }
                            }

                            // Update the appropriate text field
                            if (this.modals.todoVoiceInput) {
                                this.todoVoiceText = this.cleanVoiceText(this.finalTranscript + interimTranscript);
                            } else {
                                this.voiceText = this.cleanVoiceText(this.finalTranscript + interimTranscript);
                            }
                            this.interimTranscript = interimTranscript;
                        };

                        this.recognition.onerror = (event) => {
                            console.error('Speech recognition error:', event.error);
                            this.stopRecording();
                            if (event.error === 'not-allowed') {
                                this.showCopyToast('Microphone access denied. Please check permissions.');
                            }
                        };

                        this.recognition.onend = () => {
                            if (this.isRecording) {
                                this.stopRecording();
                            }
                        };
                    }
                },

                cleanVoiceText(text) {
                    if (!text) return '';

                    text = text.replace(/\s+/g, ' ');
                    const words = text.split(' ');
                    const uniqueWords = [];

                    for (let i = 0; i < words.length; i++) {
                        if (i === 0 || words[i] !== words[i - 1]) {
                            if (i >= 2 && words[i] === words[i - 2] && words[i - 1] === words[i - 3]) {
                                continue;
                            }
                            uniqueWords.push(words[i]);
                        }
                    }

                    text = uniqueWords.join(' ');
                    text = text.replace(/\s*\.\s*/g, '. ');
                    text = text.replace(/\s*,\s*/g, ', ');
                    text = text.replace(/\s*\?\s*/g, '? ');
                    text = text.replace(/\s*!\s*/g, '! ');
                    text = text.charAt(0).toUpperCase() + text.slice(1);
                    text = text.replace(/\s+([.,?!])/g, '$1');

                    return text.trim();
                },

                startRecording() {
                    if (this.activeTab === 'todo') {
                        this.openTodoVoiceModal();
                        return;
                    }
                    
                    this.voiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                    this.modals.voiceInput = true;
                    this.$nextTick(() => {
                        this.startActualRecording('voice');
                        lucide.createIcons();
                    });
                },

                startActualRecording(type) {
                    if (!this.recognition) {
                        this.showCopyToast('Speech recognition not supported in your browser.');
                        return;
                    }

                    try {
                        this.isRecording = true;
                        this.recordingTime = 0;
                        
                        if (type === 'todo') {
                            this.todoVoiceText = '';
                        } else {
                            this.voiceText = '';
                        }
                        
                        this.finalTranscript = '';
                        this.interimTranscript = '';

                        this.recordingTimer = setInterval(() => {
                            this.recordingTime++;
                        }, 1000);

                        this.recognition.lang = this.voiceLanguage;
                        this.recognition.start();

                    } catch (error) {
                        console.error('Error starting speech recognition:', error);
                        this.isRecording = false;
                        this.showCopyToast('Error starting voice recording.');
                    }
                },

                stopRecording() {
                    if (this.recognition && this.isRecording) {
                        try {
                            this.recognition.stop();
                        } catch (error) {
                            console.error('Error stopping speech recognition:', error);
                        }
                    }

                    this.isRecording = false;
                    if (this.recordingTimer) {
                        clearInterval(this.recordingTimer);
                        this.recordingTimer = null;
                    }

                    // Clean up the final text
                    if (this.modals.todoVoiceInput) {
                        this.todoVoiceText = this.cleanVoiceText(this.finalTranscript);
                    } else {
                        this.voiceText = this.cleanVoiceText(this.finalTranscript);
                    }

                    // If auto-save is enabled and we have text, save immediately
                    if (this.autoSaveVoiceNotes && this.voiceText.trim() && !this.modals.todoVoiceInput) {
                        setTimeout(() => this.saveVoiceNote(), 500);
                    }
                },

                closeVoiceModal() {
                    if (this.isRecording) {
                        this.stopRecording();
                    }
                    this.modals.voiceInput = false;
                    this.voiceText = '';
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                },

                // The rest of existing functions (keep them as is)
                setupHistoryNavigation() {
                    if (!window.history.state || window.history.state.view !== this.currentView) {
                        const state = { view: this.currentView };
                        if (this.currentView === 'tab') {
                            state.tab = this.activeTab;
                            window.history.replaceState(state, '', `#${this.activeTab}`);
                        } else {
                            window.history.replaceState(state, '', '#home');
                        }
                    }

                    window.addEventListener('popstate', (event) => {
                        if (event.state && event.state.view === 'tab' && event.state.tab) {
                            if (this.tabs.includes(event.state.tab)) {
                                this.currentView = 'tab';
                                this.activeTab = event.state.tab;
                            } else {
                                this.goToHome();
                            }
                        } else {
                            this.goToHome();
                        }
                    });
                },

                updateHistoryState(tab) {
                    if (this.currentView === 'tab') {
                        window.history.pushState({ view: 'tab', tab: tab }, '', `#${tab}`);
                    }
                },

                homeLongPressStart(event, tab) {
                    this.homeLongPressActive = false;
                    clearTimeout(this.homeLongPressTimer);

                    this.homeLongPressTimer = setTimeout(() => {
                        this.homeLongPressActive = true;
                        this.openTabContextMenu(tab, event);
                    }, this.longPressDuration);
                },

                homeLongPressEnd(event, tab) {
                    clearTimeout(this.homeLongPressTimer);

                    if (this.homeLongPressActive) {
                        event.preventDefault();
                        return;
                    }
                },

                longPressStart(event, tab) {
                    this.longPressActive = false;
                    clearTimeout(this.longPressTimer);

                    this.longPressTimer = setTimeout(() => {
                        this.longPressActive = true;
                        this.openTabContextMenu(tab, event);
                    }, this.longPressDuration);
                },

                longPressEnd(event, tab) {
                    clearTimeout(this.longPressTimer);

                    if (this.longPressActive) {
                        event.preventDefault();
                        return;
                    }
                },

                openTabContextMenu(tab, event) {
                    if (tab === 'secure-notes' || tab === 'cards' || tab === 'voice' || tab === 'todo') return;
                    this.currentContextTab = tab;

                    let clientX, clientY;
                    if (event.touches && event.touches.length > 0) {
                        clientX = event.touches[0].clientX;
                        clientY = event.touches[0].clientY;
                    } else if (event.changedTouches && event.changedTouches.length > 0) {
                        clientX = event.changedTouches[0].clientX;
                        clientY = event.changedTouches[0].clientY;
                    } else {
                        clientX = event.clientX;
                        clientY = event.clientY;
                    }

                    if (clientX === undefined || clientY === undefined) {
                        const targetRect = event.currentTarget.getBoundingClientRect();
                        clientX = targetRect.left + (targetRect.width / 2);
                        clientY = targetRect.bottom + 10;
                    }

                    const viewportWidth = window.innerWidth;
                    const menuWidthEstimate = 200;
                    let x = clientX;
                    let y = clientY;

                    if (x + menuWidthEstimate > viewportWidth) {
                        x = viewportWidth - menuWidthEstimate - 10;
                    }

                    this.contextMenuX = x;
                    this.contextMenuY = y;
                    this.modals.tabContext = true;
                },

                goToHome() {
                    this.currentView = 'home';
                    window.history.pushState({ view: 'home' }, '', '#home');
                    this.initializeIconsAfterUpdate();
                },

                switchToTab(tab) {
                    this.currentView = 'tab';
                    this.activeTab = tab;
                    this.updateHistoryState(tab);
                    this.initializeIconsAfterUpdate();
                },

                migrateOldData() {
                    // Keep existing migration code
                },

                migrateSecureData() {
                    if (this.data['secure']) {
                        const secureData = this.data['secure'];

                        const secureNotes = secureData.filter(item => item.type !== 'card');
                        const cards = secureData.filter(item => item.type === 'card');

                        this.data['secure-notes'] = secureNotes;
                        this.data['cards'] = cards;

                        delete this.data['secure'];

                        const secureIndex = this.tabs.indexOf('secure');
                        if (secureIndex !== -1) {
                            this.tabs.splice(secureIndex, 1, 'secure-notes', 'cards');
                        }

                        this.persist();
                    }
                },

                updateExistingMusicLinks() {
                    const musicData = this.data['music'] || [];
                    this.data['music'] = musicData.map(item => {
                        let isAutoLink = false;
                        const oldApp = this.oldMusicAppPreference;
                        const newApp = this.musicAppPreference;

                        if (oldApp !== newApp) {
                            if (item.link && (item.link.includes('spotify.com/0') || item.link.includes('apple.com/us/search') || item.link.includes('youtube.com/search'))) {
                                isAutoLink = true;
                            }
                        }

                        if (item.title && isAutoLink) {
                            item.link = this.autoGenerateMusicLink(item.title);
                        }
                        return item;
                    });
                },

                persist() {
                    if (this.oldMusicAppPreference !== this.musicAppPreference) {
                        this.updateExistingMusicLinks();
                        this.oldMusicAppPreference = this.musicAppPreference;
                    }
                    localStorage.setItem('bd_data', JSON.stringify(this.data));
                    localStorage.setItem('bd_tabs', JSON.stringify(this.tabs));
                    localStorage.setItem('bd_music_app', this.musicAppPreference);
                    localStorage.setItem('bd_default_tab', this.defaultTabID);
                    localStorage.setItem('bd_tab_metadata', JSON.stringify(this.tabMetadata));
                    localStorage.setItem('bd_theme', this.darkMode ? 'dark' : 'light');
                    localStorage.setItem('bd_current_view', this.currentView);
                    localStorage.setItem('bd_default_view', this.defaultView);
                    localStorage.setItem('bd_last_active_tab', this.activeTab);

                    localStorage.setItem('bd_voice_language', this.voiceLanguage);
                    localStorage.setItem('bd_auto_save_voice', this.autoSaveVoiceNotes);
                },

                scrollTabIntoView(tab, behavior = 'smooth', block = 'center') {
                    const tabElement = this.$refs[`tab-${tab}`];
                    if (tabElement) {
                        tabElement.scrollIntoView({ behavior: behavior, inline: block });
                    }
                },

                touchStart(e) {
                    this.touchstartX = e.changedTouches[0].screenX;
                },

                touchEnd(e) {
                    this.touchendX = e.changedTouches[0].screenX;
                    this.handleSwipe();
                },

                handleSwipe() {
                    if (this.modals.item || this.modals.cardItem || this.modals.settings || this.modals.tabContext || this.activeTab === 'secure-notes' || this.activeTab === 'cards' || this.activeTab === 'voice' || this.activeTab === 'todo') return;
                    if (this.touchendX < this.touchstartX - this.swipeThreshold) {
                        this.changeTab('next');
                    }
                    if (this.touchendX > this.touchstartX + this.swipeThreshold) {
                        this.changeTab('prev');
                    }
                },

                changeTab(direction) {
                    const visibleTabs = this.tabs.filter(t => t !== 'secure-notes' && t !== 'cards' && t !== 'voice' && t !== 'todo');
                    let currentIndex = visibleTabs.indexOf(this.activeTab);
                    let nextIndex;

                    if (direction === 'next') {
                        nextIndex = (currentIndex + 1) % visibleTabs.length;
                    } else if (direction === 'prev') {
                        nextIndex = (currentIndex - 1 + visibleTabs.length) % visibleTabs.length;
                    }
                    this.activeTab = visibleTabs[nextIndex];
                    this.updateHistoryState(this.activeTab);
                    this.scrollTabIntoView(this.activeTab, 'smooth', 'center');
                },

                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('bd_theme', this.darkMode ? 'dark' : 'light');
                },

                openSettingsModal() {
                    this.tempDefaultTabID = this.defaultTabID;
                    this.tempMusicAppPreference = this.musicAppPreference;
                    this.tempDefaultView = this.defaultView;
                    this.tempVoiceLanguage = this.voiceLanguage;
                    this.tempAutoSaveVoiceNotes = this.autoSaveVoiceNotes;
                    this.modals.settings = true;
                    this.initializeIconsAfterUpdate();
                },

                openSecureNotesSettings() {
                    this.currentView = 'tab';
                    this.activeTab = 'secure-notes';
                    this.updateHistoryState('secure-notes');
                    this.initializeIconsAfterUpdate();
                },

                confirmDeleteAllData() {
                    this.modals.settings = false;
                    this.modals.deleteAll = true;
                },

                performDeleteAllData() {
                    localStorage.removeItem('bd_data');
                    localStorage.removeItem('bd_tabs');
                    localStorage.removeItem('bd_music_app');
                    localStorage.removeItem('bd_default_tab');
                    localStorage.removeItem('bd_tab_metadata');
                    localStorage.removeItem('bd_current_view');
                    localStorage.removeItem('bd_default_view');
                    localStorage.removeItem('bd_last_active_tab');
                    localStorage.removeItem('bd_voice_language');
                    localStorage.removeItem('bd_auto_save_voice');
                    window.location.reload();
                },

                reloadApp() {
                    if (this.waitingWorker) this.waitingWorker.postMessage({ type: 'SKIP_WAITING' });
                },

                get secureNotes() {
                    return (this.data['secure-notes'] || []).filter(item => item.type !== 'card');
                },

                get cards() {
                    return (this.data['cards'] || []).sort((a, b) => b.id - a.id);
                },

                getItemType(id) {
                    if (!this.data[this.activeTab]) return 'note';
                    const item = this.data[this.activeTab].find(i => i.id === id);
                    return item ? item.type : 'note';
                },

                openAddCardModal() {
                    this.editingCard = false;
                    this.cardForm = {
                        id: Date.now(),
                        title: '',
                        number: '',
                        holder: '',
                        expiry: '',
                        cvv: '',
                        color: '#2563eb',
                        type: 'card',
                        note: ''
                    };
                    this.modals.cardItem = true;
                    this.initializeIconsAfterUpdate();
                },

                openEditCardModal(card) {
                    this.editingCard = true;
                    this.cardForm = {
                        id: card.id,
                        title: card.title,
                        number: card.number,
                        holder: card.holder,
                        expiry: this.formatExpiryDisplay(card.expiry),
                        cvv: card.cvv,
                        type: 'card',
                        note: card.note
                    };
                    this.modals.cardItem = true;
                    this.initializeIconsAfterUpdate();
                },

                openAddItemModal() {
                    this.editingItem = false;
                    this.form = {
                        id: Date.now(),
                        title: '',
                        link: '',
                        note: '',
                        isFavorite: false,
                        isDone: false,
                        type: 'note'
                    };
                    this.modals.item = true;
                    this.initializeIconsAfterUpdate();
                },

                openEditItemModal(item) {
                    if (item.type === 'card' && this.activeTab === 'cards') {
                        this.openEditCardModal(item);
                        return;
                    }
                    this.editingItem = true;
                    this.form = { ...item, type: item.type || 'note' };
                    this.modals.item = true;
                    this.initializeIconsAfterUpdate();
                },

                generateLinkForMusic() {
                    if (this.form.title.trim()) {
                        this.form.link = this.autoGenerateMusicLink(this.form.title);
                        this.showCopyToast('Link auto-generated');
                        this.initializeIconsAfterUpdate();
                    }
                },

                openNewTabModal() {
                    this.newTabName = '';
                    this.newTabType = 'normal';
                    this.modals.tab = true;
                    this.newTabError = '';
                },

                createNewTab() {
                    const newName = this.newTabName.trim().toLowerCase().replace(/\s+/g, '-');
                    this.newTabError = '';

                    if (!newName) {
                        this.newTabError = 'Please enter a name for the new tab.';
                        return;
                    }
                    if (newName === 'secure-notes' || newName === 'cards' || newName === 'voice' || newName === 'todo') {
                        this.newTabError = `"${newName}" is a reserved tab name.`;
                        return;
                    }

                    if (this.tabs.includes(newName)) {
                        this.newTabError = `A tab named "${this.newTabName.trim()}" already exists.`;
                        return;
                    }

                    const voiceIndex = this.tabs.indexOf('voice');
                    const secureIndex = this.tabs.indexOf('secure-notes');
                    const insertIndex = Math.min(voiceIndex, secureIndex);
                    this.tabs.splice(insertIndex, 0, newName);
                    this.data[newName] = [];
                    this.tabMetadata[newName] = this.newTabType;
                    this.activeTab = newName;
                    this.currentView = 'tab';
                    this.updateHistoryState(newName);

                    this.persist();
                    this.modals.tab = false;

                    this.$nextTick(() => {
                        const scroller = this.$refs.tabScroller;
                        if (scroller) {
                            scroller.scrollTo({ left: scroller.scrollWidth, behavior: 'smooth' });
                        }
                    });
                },

                openEditTabModal() {
                    this.editTabName = this.toTitleCase(this.currentContextTab);
                    this.modals.editTab = true;
                },

                saveTabRename() {
                    const oldName = this.currentContextTab;
                    const newName = this.editTabName.trim().toLowerCase().replace(/\s+/g, '-');

                    if (newName && newName !== oldName && !this.tabs.includes(newName)) {
                        const index = this.tabs.indexOf(oldName);
                        if (index !== -1) {
                            this.data[newName] = this.data[oldName];
                            delete this.data[oldName];

                            this.tabMetadata[newName] = this.tabMetadata[oldName];
                            delete this.tabMetadata[oldName];

                            this.tabs[index] = newName;
                            this.activeTab = newName;

                            if (this.defaultTabID === oldName) {
                                this.defaultTabID = newName;
                            }

                            this.persist();
                            this.$nextTick(() => {
                                this.scrollTabIntoView(newName);
                                lucide.createIcons();
                            });
                        }
                    }
                    this.modals.editTab = false;
                    this.currentContextTab = null;
                },

                confirmDeleteTab(tab) {
                    this.tabToDelete = tab;
                    this.modals.deleteTab = true;
                },

                performTabDelete() {
                    if (this.tabToDelete) {
                        const index = this.tabs.indexOf(this.tabToDelete);
                        if (index !== -1) {
                            this.tabs.splice(index, 1);
                            delete this.data[this.tabToDelete];
                            delete this.tabMetadata[this.tabToDelete];

                            if (this.activeTab === this.tabToDelete) {
                                this.activeTab = this.defaultTabID;
                                this.updateHistoryState(this.defaultTabID);
                            }

                            this.persist();
                        }
                        this.modals.deleteTab = false;
                        this.tabToDelete = null;
                        this.currentContextTab = null;
                    }
                },

                setDefaultTab(tab) {
                    if (tab !== 'secure-notes' && tab !== 'cards' && tab !== 'voice' && tab !== 'todo') {
                        this.defaultTabID = tab;
                        this.persist();
                        this.showCopyToast(this.toTitleCase(tab) + ' set as default tab');
                    }
                },

                formatExpiryInput(value) {
                    let cleaned = value.replace(/\D/g, '');
                    if (cleaned.length > 2) {
                        cleaned = cleaned.slice(0, 2) + '/' + cleaned.slice(2, 4);
                    }
                    if (cleaned.length === 5 && this.$refs.cvvInput) {
                        this.$nextTick(() => this.$refs.cvvInput.focus());
                    }
                    return cleaned.slice(0, 5);
                },
                formatExpiryDisplay(expiry) {
                    if (!expiry) return 'N/A';
                    const cleaned = expiry.replace(/\D/g, '');
                    if (cleaned.length === 4) {
                        return cleaned.slice(0, 2) + '/' + cleaned.slice(2, 4);
                    }
                    return expiry;
                },

                formatCardNumberFull(number) {
                    if (!number) return 'N/A';
                    const cleaned = number.replace(/\s/g, '');
                    return cleaned.match(/.{1,4}/g).join(' ');
                },

                copyToClipboard(text, fieldName = 'Item') {
                    if (!navigator.clipboard) {
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                    } else {
                        navigator.clipboard.writeText(text).then(() => {
                            this.showCopyToast(fieldName + ' copied!');
                        }).catch(err => {
                            console.error('Could not copy text: ', err);
                            alert('Failed to copy. Please try manually.');
                        });
                    }
                },

                showCopyToast(message) {
                    this.copyMessage = message;
                    clearTimeout(this.copyTimer);
                    this.copyTimer = setTimeout(() => {
                        this.copyMessage = null;
                    }, 1500);
                },

                getCardGradient(color) {
                    if (!color) return 'background-color: #6b7280;';

                    const adjustColor = (hex, factor) => {
                        if (!hex || hex.length < 7) return hex;
                        let colorString = hex.startsWith('#') ? hex.slice(1) : hex;

                        if (colorString.length !== 6) return hex;

                        let num = parseInt(colorString, 16);
                        let r = (num >> 16);
                        let g = (num >> 8 & 0x00FF);
                        let b = (num & 0x0000FF);

                        r = Math.round(Math.min(255, Math.max(0, r * (1 + factor))));
                        g = Math.round(Math.min(255, Math.max(0, g * (1 + factor))));
                        b = Math.round(Math.min(255, Math.max(0, b * (1 + factor))));

                        return '#' + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
                    };

                    const darker = adjustColor(color, -0.2);

                    return `background: linear-gradient(135deg, ${color}, ${darker});`;
                },

                toTitleCase(str) {
                    if (!str) return '';
                    str = str.replace(/-/g, ' ');
                    return str.toLowerCase().split(' ').map((word) => {
                        return (word.charAt(0).toUpperCase() + word.slice(1));
                    }).join(' ');
                },

                isTodoTab(tab) {
                    return this.tabMetadata[tab] === 'todo';
                },

                autoGenerateMusicLink(title) {
                    if (!title) return '';
                    const query = encodeURIComponent(title.trim());

                    if (this.musicAppPreference === 'spotify') {
                        return `https://open.spotify.com/search/${query}`;
                    } else if (this.musicAppPreference === 'apple_music') {
                        return `https://music.apple.com/search?term=${query}`;
                    } else {
                        return `https://music.youtube.com/search?q=${query}`;
                    }
                },

                getLinkIcon(link) {
                    if (!link) return `<i data-lucide="link" class="w-4 h-4 icon-link"></i>`;

                    if (link.includes('open.spotify.com/search') || link.includes('spotify:')) {
                        return `<i data-lucide="music" class="w-4 h-4 icon-spotify" fill="currentColor"></i>`;
                    } else if (link.includes('music.apple.com')) {
                        return `<i data-lucide="apple" class="w-4 h-4 icon-apple" fill="currentColor"></i>`;
                    } else if (link.includes('youtube.com') || link.includes('music.youtube.com')) {
                        return `<i data-lucide="youtube" class="w-4 h-4 icon-youtube" fill="currentColor"></i>`;
                    } else {
                        return `<i data-lucide="link" class="w-4 h-4 icon-link"></i>`;
                    }
                },

                autoGenerateGoogleSearchLink(title) {
                    if (!title) return '';
                    return `https://www.google.com/search?q=${encodeURIComponent(title.trim())}`;
                },

                autoGenerateYouTubeSearchLink(title) {
                    if (!title) return '';
                    return `https://www.youtube.com/results?search_query=${encodeURIComponent(title.trim())}`;
                },

                getTitlePlaceholder() {
                    if (this.isTodoTab(this.activeTab)) return 'e.g. Buy groceries';
                    if (this.activeTab === 'secure-notes') return 'e.g. Netflix Password';
                    if (this.activeTab === 'voice') return '';
                    return 'e.g. Item Title';
                },

                getLinkPlaceholder() {
                    if (this.activeTab === 'music') return 'https:// or tap "Auto"';
                    return 'https://... (Optional)';
                },

                getNoteLabel() {
                    if (this.isTodoTab(this.activeTab)) return 'Extra Details (Optional)';
                    if (this.activeTab === 'food') return 'Ingredients & Steps';
                    if (this.activeTab === 'travel') return 'Location Details';
                    if (this.activeTab === 'secure-notes') return 'Sensitive Information / Password Notes';
                    if (this.activeTab === 'voice') return 'Voice Note';
                    return 'Notes / Details';
                },

                getNotePlaceholder() {
                    if (this.isTodoTab(this.activeTab)) return 'Set a deadline, or add a store location.';
                    if (this.activeTab === 'food') return '- 2 Cups Rice\n- Boil water...';
                    if (this.activeTab === 'travel') return 'Best time to visit: October\nGoogle Map Coords...';
                    if (this.activeTab === 'secure-notes') return 'Write your secure notes here.';
                    if (this.activeTab === 'voice') return 'Your transcribed voice note will appear here...';
                    return 'Add any extra details here...';
                },

                getTabElementID(tab) {
                    return `tab-${tab}`;
                },

                toggleTabType(tab) {
                    const currentType = this.tabMetadata[tab] ? this.tabMetadata[tab].type : 'normal';
                    const newType = currentType === 'normal' ? 'todo' : 'normal';
                    this.tabMetadata[tab] = { type: newType };
                    this.modals.tabContext = false;
                    this.persist();
                    this.showCopyToast(`Tab type changed to ${newType}!`);
                },

                savePreferences() {
                    let preferencesChanged = false;

                    if (this.tempDefaultTabID !== this.defaultTabID) {
                        this.defaultTabID = this.tempDefaultTabID;
                        preferencesChanged = true;
                    }

                    if (this.tempMusicAppPreference !== this.musicAppPreference) {
                        this.musicAppPreference = this.tempMusicAppPreference;
                        preferencesChanged = true;
                    }

                    if (this.tempDefaultView !== this.defaultView) {
                        this.defaultView = this.tempDefaultView;
                        localStorage.setItem('bd_default_view', this.defaultView);
                        preferencesChanged = true;

                        if (this.defaultView === 'tab' && this.currentView === 'home') {
                            this.currentView = 'tab';
                            this.activeTab = this.defaultTabID;
                            this.updateHistoryState(this.defaultTabID);
                        }
                    }

                    if (this.tempVoiceLanguage !== this.voiceLanguage) {
                        this.voiceLanguage = this.tempVoiceLanguage;
                        preferencesChanged = true;
                    }

                    if (this.tempAutoSaveVoiceNotes !== this.autoSaveVoiceNotes) {
                        this.autoSaveVoiceNotes = this.tempAutoSaveVoiceNotes;
                        preferencesChanged = true;
                    }

                    if (preferencesChanged) {
                        this.persist();
                        this.showCopyToast('Preferences saved successfully!');
                    } else {
                        this.showCopyToast('No changes to save.');
                    }

                    this.modals.settings = false;
                },
            }
        }
    </script>
</body>
</html>